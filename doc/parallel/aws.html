<!DOCTYPE html>

<html>
<head>
  <title>aws.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="api.html">
                api.js
              </a>
            
              
              <a class="source" href="aws.html">
                aws.js
              </a>
            
              
              <a class="source" href="core.html">
                core.js
              </a>
            
              
              <a class="source" href="db.html">
                db.js
              </a>
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="logger.html">
                logger.js
              </a>
            
              
              <a class="source" href="server.html">
                server.js
              </a>
            
              
              <a class="source" href="tests.html">
                tests.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>aws.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p> Author: Vlad Seryakov vseryakov@gmail.com
 Feb 2012</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> util = require(<span class="string">'util'</span>);
<span class="keyword">var</span> http = require(<span class="string">'http'</span>);
<span class="keyword">var</span> url = require(<span class="string">'url'</span>);
<span class="keyword">var</span> fs = require(<span class="string">'fs'</span>);
<span class="keyword">var</span> os = require(<span class="string">'os'</span>);
<span class="keyword">var</span> cluster = require(<span class="string">'cluster'</span>);
<span class="keyword">var</span> logger = require(__dirname + <span class="string">'/logger'</span>);
<span class="keyword">var</span> core = require(__dirname + <span class="string">'/core'</span>);
<span class="keyword">var</span> printf = require(<span class="string">'printf'</span>);
<span class="keyword">var</span> async = require(<span class="string">'async'</span>);
<span class="keyword">var</span> cheerio = require(<span class="string">'cheerio'</span>);
<span class="keyword">var</span> xml2json = require(<span class="string">'xml2json'</span>);

<span class="keyword">var</span> aws = {
    name: <span class="string">'aws'</span>,
    args: [ { name: <span class="string">"key"</span>, descr: <span class="string">"AWS access key"</span> },
            { name: <span class="string">"secret"</span>, descr: <span class="string">"AWS access secret"</span> },
            { name: <span class="string">"region"</span>, descr: <span class="string">"AWS region"</span> },
            { name: <span class="string">"keypair"</span>, descr: <span class="string">"AWS instance keypair name"</span> },
            { name: <span class="string">"image"</span>, descr: <span class="string">"AWS image id to be used for remote jobs"</span> },
            { name: <span class="string">"instance"</span>, descr: <span class="string">"AWS instance type"</span> },
            { name: <span class="string">"dynamodb-host"</span>, descr: <span class="string">"Custom DynamoDB host for local installations"</span> },
            { name: <span class="string">"nometadata"</span>, type: <span class="string">"bool"</span>, descr: <span class="string">"Skip retrieval from instance metadata"</span> }],
            
    region: <span class="string">'us-east-1'</span>,
    s3: <span class="string">"s3.amazonaws.com"</span>,
    instance: <span class="string">"t1.micro"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Translation map for operators</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    opMap: { <span class="string">'like%'</span>: <span class="string">'begins_with'</span>, <span class="string">'='</span>: <span class="string">'eq'</span>, <span class="string">'&lt;='</span>: <span class="string">'le'</span>, <span class="string">'&lt;'</span>: <span class="string">'lt'</span>, <span class="string">'&gt;='</span>: <span class="string">'ge'</span>, <span class="string">'&gt;'</span>: <span class="string">'gt'</span> },</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Initialization to be run inside core.init in master mode only</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    initModule: <span class="function"><span class="keyword">function</span><span class="params">(next)</span> {</span>
        <span class="keyword">if</span> (!<span class="keyword">this</span>.nometadata) <span class="keyword">this</span>.getInstanceInfo(next); <span class="keyword">else</span> next();
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Make AWS request, return parsed response as Javascript object or null in case of error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    queryAWS: <span class="function"><span class="keyword">function</span><span class="params">(proto, method, host, path, obj, callback)</span> {</span>
        <span class="keyword">var</span> curTime = <span class="keyword">new</span> Date();
        <span class="keyword">var</span> formattedTime = curTime.toISOString().replace(<span class="regexp">/\.[0-9]+Z$/</span>, <span class="string">'Z'</span>);
        <span class="keyword">var</span> sigValues = <span class="keyword">new</span> Array();
        sigValues.push([<span class="string">"AWSAccessKeyId"</span>, <span class="keyword">this</span>.key]);
        sigValues.push([<span class="string">"SignatureMethod"</span>, <span class="string">"HmacSHA256"</span>]);
        sigValues.push(<span class="keyword">new</span> Array(<span class="string">"SignatureVersion"</span>, <span class="string">"2"</span>));
        sigValues.push([<span class="string">"Timestamp"</span>, formattedTime]);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Mix in the additional parameters. params must be an Array of tuples as for sigValues above</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> obj) {
            sigValues.push([p, obj[p]]);
        }
        <span class="keyword">var</span> strSign = <span class="string">""</span>, query = <span class="string">""</span>, postdata = <span class="string">""</span>;

        <span class="function"><span class="keyword">function</span> <span class="title">encode</span><span class="params">(str)</span> {</span>
            str = encodeURIComponent(str);
            <span class="keyword">var</span> efunc = <span class="function"><span class="keyword">function</span><span class="params">(m)</span> {</span> <span class="keyword">return</span> m == <span class="string">'!'</span> ? <span class="string">'%21'</span> : m == <span class="string">"'"</span> ? <span class="string">'%27'</span> : m == <span class="string">'('</span> ? <span class="string">'%28'</span> : m == <span class="string">')'</span> ? <span class="string">'%29'</span> : m == <span class="string">'*'</span> ? <span class="string">'%2A'</span> : m; }
            <span class="keyword">return</span> str.replace(<span class="regexp">/[!'()*~]/g</span>, efunc);
        }

        sigValues.sort();
        strSign = method + <span class="string">"\n"</span> + host + <span class="string">"\n"</span> + path + <span class="string">"\n"</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; sigValues.length; i++) {
            <span class="keyword">var</span> item = (i ? <span class="string">"&amp;"</span> : <span class="string">""</span>) + sigValues[i][<span class="number">0</span>] + <span class="string">"="</span> + encode(sigValues[i][<span class="number">1</span>]);
            strSign += item;
            query += item;
        }
        query += <span class="string">"&amp;Signature="</span> + encodeURIComponent(core.sign(<span class="keyword">this</span>.secret, strSign, <span class="string">'sha256'</span>));
        <span class="keyword">if</span> (method == <span class="string">"POST"</span>) postdata = query, query = <span class="string">""</span>;

        core.httpGet(proto + host + path + <span class="string">'?'</span> + query, { method: method, postdata: postdata }, <span class="function"><span class="keyword">function</span><span class="params">(err, params)</span> {</span>
            <span class="keyword">if</span> (err || !params.data) <span class="keyword">return</span> callback ? callback(err) : <span class="literal">null</span>;
            <span class="keyword">var</span> obj = <span class="literal">null</span>;
            <span class="keyword">try</span> { obj = xml2json.toJson(params.data, { object: <span class="literal">true</span> }); } <span class="keyword">catch</span>(e) { err = e }
            <span class="keyword">if</span> (logger.level || params.status != <span class="number">200</span>) logger.log(<span class="string">'queryAWS:'</span>, query, util.inspect(obj, <span class="literal">true</span>, <span class="literal">null</span>));
            <span class="keyword">if</span> (callback) callback(err, obj);
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>AWS EC2 API parameters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    queryEC2: <span class="function"><span class="keyword">function</span><span class="params">(action, obj, callback)</span> {</span>
        <span class="keyword">var</span> req = { Action: action, Version: <span class="string">'2012-12-01'</span> };
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> obj) req[p] = obj[p];
        <span class="keyword">this</span>.queryAWS(<span class="string">'http://'</span>, <span class="string">'POST'</span>, <span class="string">'ec2.'</span> + <span class="keyword">this</span>.region + <span class="string">'.amazonaws.com'</span>, <span class="string">'/'</span>, req, callback);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Build version 4 signature headers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    querySign: <span class="function"><span class="keyword">function</span><span class="params">(service, host, method, path, body, headers)</span> {</span>
        <span class="keyword">var</span> now = <span class="keyword">new</span> Date();
        <span class="keyword">var</span> date = now.toISOString().replace(<span class="regexp">/[:\-]|\.\d{3}/g</span>, <span class="string">''</span>);
        <span class="keyword">var</span> datetime = date.substr(<span class="number">0</span>, <span class="number">8</span>);

        headers[<span class="string">'Host'</span>] = host;
        headers[<span class="string">'X-Amz-Date'</span>] = date;
        <span class="keyword">if</span> (body &amp;&amp; !headers[<span class="string">'content-type'</span>]) headers[<span class="string">'content-type'</span>] = <span class="string">'application/x-www-form-urlencoded; charset=utf-8'</span>;
        <span class="keyword">if</span> (body &amp;&amp; !headers[<span class="string">'content-length'</span>]) headers[<span class="string">'content-length'</span>] = body.length;

        <span class="function"><span class="keyword">function</span> <span class="title">trimAll</span><span class="params">(header)</span> {</span> <span class="keyword">return</span> header.toString().trim().replace(<span class="regexp">/\s+/g</span>, <span class="string">' '</span>); }
        <span class="keyword">var</span> credString = [ datetime, <span class="keyword">this</span>.region, service, <span class="string">'aws4_request'</span> ].join(<span class="string">'/'</span>);
        <span class="keyword">var</span> pathParts = path.split(<span class="string">'?'</span>, <span class="number">2</span>);
        <span class="keyword">var</span> signedHeaders = Object.keys(headers).map(<span class="function"><span class="keyword">function</span><span class="params">(key)</span> {</span> <span class="keyword">return</span> key.toLowerCase(); }).sort().join(<span class="string">';'</span>);
        <span class="keyword">var</span> canonHeaders = Object.keys(headers).sort(<span class="function"><span class="keyword">function</span><span class="params">(a, b)</span> {</span> <span class="keyword">return</span> a.toLowerCase() &lt; b.toLowerCase() ? -<span class="number">1</span> : <span class="number">1</span>; }).map(<span class="function"><span class="keyword">function</span><span class="params">(key)</span> {</span> <span class="keyword">return</span> key.toLowerCase() + <span class="string">':'</span> + trimAll(String(headers[key])); }).join(<span class="string">'\n'</span>);
        <span class="keyword">var</span> canonString = [ method, pathParts[<span class="number">0</span>] || <span class="string">'/'</span>, pathParts[<span class="number">1</span>] || <span class="string">''</span>, canonHeaders + <span class="string">'\n'</span>, signedHeaders, core.hash(body || <span class="string">''</span>, <span class="string">"sha256"</span>, <span class="string">"hex"</span>)].join(<span class="string">'\n'</span>);

        <span class="keyword">var</span> strToSign = [ <span class="string">'AWS4-HMAC-SHA256'</span>, date, credString, core.hash(canonString, <span class="string">"sha256"</span>, <span class="string">"hex"</span>) ].join(<span class="string">'\n'</span>);
        <span class="keyword">var</span> kDate = core.sign(<span class="string">'AWS4'</span> + <span class="keyword">this</span>.secret, datetime, <span class="string">"sha256"</span>, <span class="string">"binary"</span>);
        <span class="keyword">var</span> kRegion = core.sign(kDate, <span class="keyword">this</span>.region, <span class="string">"sha256"</span>, <span class="string">"binary"</span>);
        <span class="keyword">var</span> kService = core.sign(kRegion, service, <span class="string">"sha256"</span>, <span class="string">"binary"</span>);
        <span class="keyword">var</span> kCredentials = core.sign(kService, <span class="string">'aws4_request'</span>, <span class="string">"sha256"</span>, <span class="string">"binary"</span>);
        <span class="keyword">var</span> sig = core.sign(kCredentials, strToSign, <span class="string">"sha256"</span>, <span class="string">"hex"</span>);
        headers[<span class="string">'Authorization'</span>] = [ <span class="string">'AWS4-HMAC-SHA256 Credential='</span> + <span class="keyword">this</span>.key + <span class="string">'/'</span> + credString, <span class="string">'SignedHeaders='</span> + signedHeaders, <span class="string">'Signature='</span> + sig ].join(<span class="string">', '</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>DynamoDB requests</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    queryDDB: <span class="function"><span class="keyword">function</span> <span class="params">(action, obj, options, callback)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = {};
        <span class="keyword">var</span> start = core.mnow();
        <span class="keyword">var</span> uri = options.db || (<span class="string">'https://dynamodb.'</span> + <span class="keyword">this</span>.region + <span class="string">'.amazonaws.com/'</span>);
        <span class="keyword">var</span> version = <span class="string">'2012-08-10'</span>;
        <span class="keyword">var</span> target = <span class="string">'DynamoDB_'</span> + version.replace(<span class="regexp">/\-/g</span>,<span class="string">''</span>) + <span class="string">'.'</span> + action;
        <span class="keyword">var</span> req = url.parse(uri);
        <span class="keyword">var</span> json = JSON.stringify(obj);
        <span class="keyword">var</span> headers = { <span class="string">'content-type'</span>: <span class="string">'application/x-amz-json-1.0; charset=utf-8'</span>, <span class="string">'x-amz-target'</span>: target };
        logger.debug(<span class="string">'queryDDB:'</span>, action, uri, <span class="string">'obj:'</span>, obj, <span class="string">'options:'</span>, options);
        
        <span class="keyword">this</span>.querySign(<span class="string">"dynamodb"</span>, req.hostname, <span class="string">"POST"</span>, req.path, json, headers);
        core.httpGet(uri, { method: <span class="string">"POST"</span>, postdata: json, headers: headers }, <span class="function"><span class="keyword">function</span><span class="params">(err, params)</span> {</span>
            <span class="keyword">if</span> (err) <span class="keyword">return</span> callback ? callback(err, {}) : <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Reply is always JSON but we dont take any chances</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">try</span> { params.json = JSON.parse(params.data); } <span class="keyword">catch</span>(e) { err = e; params.status += <span class="number">1000</span>; }
            <span class="keyword">if</span> (params.status != <span class="number">200</span>) {
                logger.error(<span class="string">'queryDDB:'</span>, action, util.inspect(obj, <span class="literal">null</span>, <span class="literal">null</span>), err || params.data);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Try several times</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (options.retries &gt; <span class="number">0</span> &amp;&amp; (params.status == <span class="number">500</span> || params.data.match(<span class="regexp">/(ProvisionedThroughputExceededException|ThrottlingException|ThrottlingException)/</span>))) {
                    options.retries--;
                    <span class="keyword">return</span> setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> self.queryDDB(action, obj, options, callback); }, options.timeout);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Report about the error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (!err) err = <span class="keyword">new</span> Error(params.json.__type + <span class="string">": "</span> + (params.json.message || params.json.Message));
                <span class="keyword">return</span> callback ? callback(err, {}) : <span class="literal">null</span>;
            }
            logger.debug(<span class="string">'queryDDB:'</span>, action, <span class="string">'finished:'</span>, core.mnow() - start, <span class="string">'ms'</span>, params.json.Item ? <span class="number">1</span> : (params.json.Count || <span class="number">0</span>), <span class="string">'rows'</span>, params.json.ConsumedCapacity || <span class="string">""</span>);
            <span class="keyword">if</span> (callback) callback(err, params.json);
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Sign S3 AWS request, returns url to be send to S3 server, options will have all updated headers to be sent as well</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    signS3: <span class="function"><span class="keyword">function</span><span class="params">(method, bucket, key, query, headers, expires)</span> {</span>
        <span class="keyword">var</span> curTime = <span class="keyword">new</span> Date().toUTCString();
        <span class="keyword">if</span> (!headers[<span class="string">"x-amz-date"</span>]) headers[<span class="string">"x-amz-date"</span>] = curTime;
        <span class="keyword">if</span> (!headers[<span class="string">"content-type"</span>]) headers[<span class="string">"content-type"</span>] = <span class="string">"binary/octet-stream; charset=utf-8"</span>;
        <span class="keyword">if</span> (<span class="keyword">this</span>.securityToken) headers[<span class="string">"x-amz-security-token"</span>] = <span class="keyword">this</span>.securityToken;
        <span class="keyword">if</span> (headers[<span class="string">"content-type"</span>] &amp;&amp; headers[<span class="string">"content-type"</span>].indexOf(<span class="string">"charset="</span>) == -<span class="number">1</span>) headers[<span class="string">"content-type"</span>] += <span class="string">"; charset=utf-8"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Construct the string to sign and query string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> strSign = (method || <span class="string">"GET"</span>) + <span class="string">"\n"</span> + (headers[<span class="string">'content-md5'</span>]  || <span class="string">""</span>) + <span class="string">"\n"</span> + (headers[<span class="string">'content-type'</span>] || <span class="string">""</span>) + <span class="string">"\n"</span> + (expires || <span class="string">""</span>) + <span class="string">"\n"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Amazon canonical headers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> hdrs = [];
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> headers) {
            <span class="keyword">if</span> (<span class="regexp">/X-AMZ-/i</span>.test(p)) {
                <span class="keyword">var</span> value = headers[p];
                <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Array) value = value.join(<span class="string">','</span>);
                hdrs.push(p.toString().toLowerCase() + <span class="string">':'</span> + value);
            }
        }
        <span class="keyword">if</span> (hdrs.length) strSign += hdrs.sort().join(<span class="string">'\n'</span>) + <span class="string">"\n"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Split query string for subresources, supported are:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> resources = [<span class="string">"acl"</span>, <span class="string">"lifecycle"</span>, <span class="string">"location"</span>, <span class="string">"logging"</span>, <span class="string">"notification"</span>, <span class="string">"partNumber"</span>, <span class="string">"policy"</span>, <span class="string">"requestPayment"</span>, <span class="string">"torrent"</span>,
                         <span class="string">"uploadId"</span>, <span class="string">"uploads"</span>, <span class="string">"versionId"</span>, <span class="string">"versioning"</span>, <span class="string">"versions"</span>, <span class="string">"website"</span>, <span class="string">"cors"</span>,
                         <span class="string">"delete"</span>,
                         <span class="string">"response-content-type"</span>, <span class="string">"response-content-language"</span>, <span class="string">"response-expires"</span>,
                         <span class="string">"response-cache-control"</span>, <span class="string">"response-content-disposition"</span>, <span class="string">"response-content-encoding"</span> ];
        <span class="keyword">var</span> rc = [];
        <span class="keyword">for</span> (p <span class="keyword">in</span> query) {
            p = p.toLowerCase();
            <span class="keyword">if</span> (resources.indexOf(p) != -<span class="number">1</span>) rc.push(p + (query[p] == <span class="literal">null</span> ? <span class="string">""</span> : <span class="string">"="</span> + query[p]));
        }
        strSign += (bucket ? <span class="string">"/"</span> + bucket : <span class="string">""</span>).toLowerCase() + (key[<span class="number">0</span>] != <span class="string">"/"</span> ? <span class="string">"/"</span> : <span class="string">""</span>) + encodeURI(key) + (rc.length ? <span class="string">"?"</span> : <span class="string">""</span>) + rc.sort().join(<span class="string">"&amp;"</span>);
        <span class="keyword">var</span> signature = core.sign(<span class="keyword">this</span>.secret, strSign);
        headers[<span class="string">"authorization"</span>] = <span class="string">"AWS "</span> + <span class="keyword">this</span>.key + <span class="string">":"</span> + signature;

        <span class="keyword">var</span> uri = <span class="string">'http://'</span> + (bucket ? bucket + <span class="string">"."</span> : <span class="string">""</span>) + <span class="keyword">this</span>.s3 + (key[<span class="number">0</span>] != <span class="string">"/"</span> ? <span class="string">"/"</span> : <span class="string">""</span>) + key + url.format({ query: query });</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Build REST url if expires is given, no need to send headers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (expires) {
            uri += (uri.indexOf(<span class="string">"?"</span>) == -<span class="number">1</span> ? <span class="string">"?"</span> : <span class="string">""</span>) + <span class="string">'&amp;AWSAccessKeyId='</span> + <span class="keyword">this</span>.key + <span class="string">"&amp;Expires="</span> + expires + <span class="string">"&amp;Signature="</span> + encodeURIComponent(signature);
        }
        logger.debug(<span class="string">'signS3:'</span>, uri, headers);
        <span class="keyword">return</span> uri;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>S3 requests
Options may contain the following properties:</p>
<ul>
<li>method - HTTP method</li>
<li>query - query parameters for the url as an object</li>
<li>postdata - any data to be sent with POST</li>
<li>postfile - file to be uploaded to S3 bucket</li>
<li>expires - absolute time when this request is expires</li>
<li>headers - HTTP headers to be sent with request</li>
<li>file - file name where to save downloaded contents</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    queryS3: <span class="function"><span class="keyword">function</span><span class="params">(bucket, key, options, callback)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = {};
        <span class="keyword">if</span> (!options) options = {};
        <span class="keyword">if</span> (!options.headers) options.headers = {};
        <span class="keyword">var</span> uri = <span class="keyword">this</span>.signS3(options.method, bucket, key, options.query, options.headers, options.expires);
        core.httpGet(uri, options, <span class="function"><span class="keyword">function</span><span class="params">(err, params)</span> {</span>
            <span class="keyword">if</span> (params.status != <span class="number">200</span>) logger.error(<span class="string">'queryS3:'</span>, uri, params.status, params.headers, params.data);
            <span class="keyword">if</span> (callback) callback(err, params);
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Run AWS instances with given arguments in user-data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    runInstances: <span class="function"><span class="keyword">function</span><span class="params">(count, args, callback)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;

        <span class="keyword">if</span> (!<span class="keyword">this</span>.image) <span class="keyword">return</span> callback ? callback(<span class="keyword">new</span> Error(<span class="string">"no imageId configured"</span>), obj) : <span class="literal">null</span>;
        
        <span class="keyword">var</span> req = { MinCount: count,
                    MaxCount: count,
                    ImageId: <span class="keyword">this</span>.image,
                    InstanceType: <span class="keyword">this</span>.instance,
                    KeyName: <span class="keyword">this</span>.keypair,
                    InstanceInitiatedShutdownBehavior: <span class="string">"terminate"</span>,
                    UserData: <span class="keyword">new</span> Buffer(args).toString(<span class="string">"base64"</span>) };

        logger.log(<span class="string">'runInstances:'</span>, <span class="keyword">this</span>.name, <span class="string">'count:'</span>, count, <span class="string">'ami:'</span>, <span class="keyword">this</span>.image, <span class="string">'key:'</span>, <span class="keyword">this</span>.keypair, <span class="string">'args:'</span>, args);
        <span class="keyword">this</span>.queryEC2(<span class="string">"RunInstances"</span>, req, <span class="function"><span class="keyword">function</span><span class="params">(err, obj)</span> {</span>
            logger.elog(err, <span class="string">'runInstances:'</span>, self.name, util.inspect(obj, <span class="literal">true</span>, <span class="literal">null</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Update tag name with current job</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (obj &amp;&amp; obj.RunInstancesResponse &amp;&amp; obj.RunInstancesResponse.instancesSet) {
                <span class="keyword">var</span> item = obj.RunInstancesResponse.instancesSet.item;
                <span class="keyword">if</span> (!Array.isArray(item)) item = [ item ];
                <span class="keyword">var</span> d = args.match(<span class="regexp">/\-jobname ([^ ]+)/i</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Update tags with delay to allow instances appear in the system</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (d) setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                    item.forEach(<span class="function"><span class="keyword">function</span><span class="params">(x)</span> {</span> self.queryEC2(<span class="string">"CreateTags"</span>, { <span class="string">"ResourceId.1"</span>: x.instanceId, <span class="string">"Tag.1.Key"</span>: <span class="string">'Name'</span>, <span class="string">"Tag.1.Value"</span>: d[<span class="number">1</span>] }); });
                }, <span class="number">15000</span>);
            }
            <span class="keyword">if</span> (callback) callback(err, obj);
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Retrieve instance meta data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    getInstanceMeta: <span class="function"><span class="keyword">function</span><span class="params">(path, callback)</span> {</span>
        core.httpGet(<span class="string">"http://169.254.169.254"</span> + path, { httpTimeout: <span class="number">100</span>, quiet: <span class="literal">true</span> }, <span class="function"><span class="keyword">function</span><span class="params">(err, params)</span> {</span>
            logger.debug(<span class="string">'getInstanceMeta:'</span>, path, params.data, err || <span class="string">""</span>);
            <span class="keyword">if</span> (callback) callback(err, params.data);
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Retrieve instance launch index from the meata data if running on AWS instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    getInstanceInfo: <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;

        self.getInstanceMeta(<span class="string">"/latest/meta-data/ami-launch-index"</span>, <span class="function"><span class="keyword">function</span><span class="params">(err, idx)</span> {</span>
            <span class="keyword">if</span> (!err &amp;&amp; idx) core.instanceIndex = core.toNumber(idx);
            self.getInstanceMeta(<span class="string">"/latest/meta-data/instance-id"</span>, <span class="function"><span class="keyword">function</span><span class="params">(err2, id)</span> {</span>
                <span class="keyword">if</span> (!err2 &amp;&amp; id) core.instanceId = id;
                logger.log(<span class="string">'getInstanceInfo:'</span>, self.name, <span class="string">'id:'</span>, core.instanceId, <span class="string">'index:'</span>, core.instanceIndex, <span class="string">'/'</span>, idx, err || err2 || <span class="string">""</span>);
                <span class="keyword">if</span> (callback) callback();
            });
        });
    },

    toDynamoDB: <span class="function"><span class="keyword">function</span><span class="params">(value, level)</span> {</span>
        <span class="keyword">switch</span> (core.typeName(value)) {
        <span class="keyword">case</span> <span class="string">'number'</span>:
            <span class="keyword">return</span> { <span class="string">"N"</span>: value.toString() };

        <span class="keyword">case</span> <span class="string">'buffer'</span>:
            <span class="keyword">return</span> { <span class="string">"B"</span>: value.toString(<span class="string">"base64"</span>) };

        <span class="keyword">case</span> <span class="string">'array'</span>:
            <span class="keyword">var</span> obj = {}, arr = [], type = <span class="string">''</span>;
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; value.length; ++i) {
                <span class="keyword">if</span> (!value[i] &amp;&amp; <span class="keyword">typeof</span> value[i] != <span class="string">'number'</span>) <span class="keyword">continue</span>;
                <span class="keyword">if</span> (Array.isArray(value[i]) &amp;&amp; !value[i].length) <span class="keyword">continue</span>;
                arr[i] = String(value[i]);
                <span class="keyword">if</span> (!type) type = core.typeName(value[i]);
            }
            obj[type == <span class="string">"number"</span> ? <span class="string">"NS"</span>: type == <span class="string">"buffer"</span> ? <span class="string">"BS"</span> : <span class="string">"SS"</span>] = arr;
            <span class="keyword">return</span> obj;

        <span class="keyword">case</span> <span class="string">"date"</span>:
            <span class="keyword">return</span> { <span class="string">"N"</span>: Math.round(value.getTime()/<span class="number">1000</span>) };
            
        <span class="keyword">case</span> <span class="string">'object'</span>:
            <span class="keyword">if</span> (level) <span class="keyword">return</span> { <span class="string">"S"</span> : JSON.stringify(value) };
            <span class="keyword">var</span> obj = {};
            <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> value) {
                <span class="keyword">if</span> (!value[i] &amp;&amp; <span class="keyword">typeof</span> value[i] != <span class="string">'number'</span>) <span class="keyword">continue</span>;
                <span class="keyword">if</span> (Array.isArray(value[i]) &amp;&amp; !value[i].length) <span class="keyword">continue</span>;
                obj[i] = <span class="keyword">this</span>.toDynamoDB(value[i], level || <span class="number">1</span>);
            }
            <span class="keyword">return</span> obj;
            
        <span class="keyword">default</span>:
            <span class="keyword">return</span> { <span class="string">"S"</span>: String(value) };
        }
    },

    fromDynamoDB: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">switch</span> (core.typeName(value)) {
        <span class="keyword">case</span> <span class="string">'array'</span>:
            <span class="keyword">return</span> value.map(<span class="function"><span class="keyword">function</span><span class="params">(x)</span> {</span> <span class="keyword">return</span> self.fromDynamoDB(x) });

        <span class="keyword">case</span> <span class="string">'object'</span>:
            <span class="keyword">var</span> res = {};
            <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> value) {
                <span class="keyword">if</span> (value.hasOwnProperty(i)) {
                    <span class="keyword">if</span> (value[i][<span class="string">'S'</span>])
                        res[i] = value[i][<span class="string">'S'</span>];
                    <span class="keyword">else</span>
                    <span class="keyword">if</span> (value[i][<span class="string">'SS'</span>])
                        res[i] = value[i][<span class="string">'SS'</span>];
                    <span class="keyword">else</span>
                    <span class="keyword">if</span> (value[i][<span class="string">'B'</span>])
                        res[i] = <span class="keyword">new</span> Buffer(value[i][<span class="string">'B'</span>], <span class="string">"base64"</span>);
                    <span class="keyword">else</span>
                    <span class="keyword">if</span> (value[i][<span class="string">'BS'</span>]) {
                        res[i] = [];
                        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; value[i][<span class="string">'BS'</span>].length; j ++) {
                            res[i][j] = <span class="keyword">new</span> Buffer(value[i][<span class="string">'BS'</span>][j], <span class="string">"base64"</span>);
                        }
                    } <span class="keyword">else</span>
                    <span class="keyword">if</span> (value[i][<span class="string">'N'</span>])
                        res[i] = parseFloat(value[i][<span class="string">'N'</span>]);
                    <span class="keyword">else</span>
                    <span class="keyword">if</span> (value[i][<span class="string">'NS'</span>]) {
                        res[i] = [];
                        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; value[i][<span class="string">'NS'</span>].length; j ++) {
                            res[i][j] = parseFloat(value[i][<span class="string">'NS'</span>][j]);
                        }
                    }
                }
            }
            <span class="keyword">return</span> res;

        <span class="keyword">default</span>:
            <span class="keyword">return</span> value;
        }
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Return list of tables in .TableNames property of the result
Example: { TableNames: [ name, ...] }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ddbListTables: <span class="function"><span class="keyword">function</span><span class="params">(options, callback)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = {};
        <span class="keyword">if</span> (!options) options = {};
        <span class="keyword">this</span>.queryDDB(<span class="string">'ListTables'</span>, {}, options, callback);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Return table definition and parameters in the result structure with property of the given table name
Example: { name: { AttributeDefinitions: [], KeySchema: [] ...} }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ddbDescribeTable: <span class="function"><span class="keyword">function</span><span class="params">(name, options, callback)</span> {</span>
        <span class="keyword">var</span> params = { TableName: name };
        <span class="keyword">this</span>.queryDDB(<span class="string">'DescribeTable'</span>, params, options, <span class="function"><span class="keyword">function</span><span class="params">(err, rc)</span> {</span>
            logger.debug(<span class="string">'DescribeTable:'</span>, name, util.inspect(rc, <span class="literal">null</span>, <span class="literal">null</span>));
            <span class="keyword">if</span> (callback) callback(err, rc);
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Create a table</p>
<ul>
<li>attrs can be an array in native DDB JSON format or an object with name:type properties, type is one of S, N, NN, NS, BS</li>
<li>keys can be an array in native DDB JSON format or an object with name:keytype properties, keytype is one of HASH or RANGE</li>
<li>indexes can be an array in native DDB JSON format or an object with each property for an index name and
value in the same format as for primary keys, additional property _projection defines projection type for an index.</li>
<li>options may contain any valid native property if it starts with capital letter.
Example: ddbCreateTable(&#39;users&#39;, {id:&#39;S&#39;,mtime:&#39;N&#39;,name:&#39;S&#39;}, {id:&#39;HASH&#39;,name:&#39;RANGE&#39;}, {mtime:{mtime:&quot;HASH&quot;,_projection:&quot;ALL&quot;}}, {ReadCapacityUnits:1,WriteCapacityUnits:1});</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ddbCreateTable: <span class="function"><span class="keyword">function</span><span class="params">(name, attrs, keys, indexes, options, callback)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = {};
        <span class="keyword">if</span> (!options) options = {};
        <span class="keyword">var</span> params = { <span class="string">"TableName"</span>: name, <span class="string">"AttributeDefinitions"</span>: [], <span class="string">"KeySchema"</span>: [], <span class="string">"ProvisionedThroughput"</span>: {<span class="string">"ReadCapacityUnits"</span>: options.ReadCapacityUnits || <span class="number">10</span>, <span class="string">"WriteCapacityUnits"</span>: options.WriteCapacityUnits || <span class="number">5</span> }};
        
        <span class="keyword">if</span> (Array.isArray(attrs) &amp;&amp; attrs.length) {
            params.AttributeDefinitions = attrs;
        } <span class="keyword">else</span> {
            <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> attrs) {
                params.AttributeDefinitions.push({ AttributeName: p, AttributeType: String(attrs[p]).toUpperCase() })
            }
        }
        <span class="keyword">if</span> (Array.isArray(keys) &amp;&amp; keys.length) {
            params.KeySchema = attrs;
        } <span class="keyword">else</span> {
            <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> keys) {
                params.KeySchema.push({ AttributeName: p, KeyType: String(keys[p]).toUpperCase() })
            }
        }
        <span class="keyword">if</span> (Array.isArray(indexes) &amp;&amp; indexes.length) {
            params.LocalSecondaryIndexes = indexes;
        } <span class="keyword">else</span> {
            <span class="keyword">for</span> (<span class="keyword">var</span> n <span class="keyword">in</span> indexes) {
                <span class="keyword">var</span> idx = indexes[n];
                <span class="keyword">var</span> index = { IndexName: n, KeySchema: [] };
                <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> idx) {
                    index.KeySchema.push({ AttributeName: p, KeyType: String(idx[p]).toUpperCase() })
                }
                <span class="keyword">if</span> (idx._projection) {
                    index.Projection = { ProjectionType: Array.isArray(idx._projection) ? <span class="string">"INLCUDE"</span> : String(idx._projection).toUpperCase() };
                    <span class="keyword">if</span> (index.Projection.ProjectionType == <span class="string">"INLCLUDE"</span>) index.Projection.NonKeyAttributes = idx._projection;
                } <span class="keyword">else</span> {
                    index.Projection = { ProjectionType: <span class="string">"KEYS_ONLY"</span> };
                }
                <span class="keyword">if</span> (!params.LocalSecondaryIndexes) params.LocalSecondaryIndexes = [];
                params.LocalSecondaryIndexes.push(index);
            }
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> options) {
            <span class="keyword">if</span> (p[<span class="number">0</span>] &gt;= <span class="string">'A'</span> &amp;&amp; p[<span class="number">0</span>] &lt;= <span class="string">'Z'</span>) params[p] = options[p];
        }

        <span class="keyword">this</span>.queryDDB(<span class="string">'CreateTable'</span>, params, options, callback);
    },

    ddbDeleteTable: <span class="function"><span class="keyword">function</span><span class="params">(name, options, callback)</span> {</span>
        <span class="keyword">var</span> params = { TableName: name };
        <span class="keyword">this</span>.queryDDB(<span class="string">'DeleteTable'</span>, params, options, callback);
    },

    ddbUpdateTable: <span class="function"><span class="keyword">function</span><span class="params">(name, rlimit, wlimit, options, callback)</span> {</span>
        <span class="keyword">var</span> params = {<span class="string">"TableName"</span>: name, <span class="string">"ProvisionedThroughput"</span>: {<span class="string">"ReadCapacityUnits"</span>:rlimit,<span class="string">"WriteCapacityUnits"</span>:wlimit } };
        <span class="keyword">this</span>.queryDDB(<span class="string">'UpdateTable'</span>, params, options, callback);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Retrieve one item by primary key</p>
<ul>
<li>keys - an object with primary key attributes name and value.</li>
<li>select - list of columns to return, otherwise all columns will be returned</li>
<li>options may contain any native property allowed in the request or special properties:<ul>
<li>consistent - set consistency level for the request
Example: ddbGetItem(&quot;users&quot;, { id: 1, name: &quot;john&quot; }, { select: &#39;id,name&#39; })</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ddbGetItem: <span class="function"><span class="keyword">function</span><span class="params">(name, keys, options, callback)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = {};
        <span class="keyword">if</span> (!options) options = {};
        <span class="keyword">var</span> params = { TableName: name, Key: {} };
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> options) {
            <span class="keyword">if</span> (p[<span class="number">0</span>] &gt;= <span class="string">'A'</span> &amp;&amp; p[<span class="number">0</span>] &lt;= <span class="string">'Z'</span>) params[p] = options[p];
        }
        <span class="keyword">if</span> (options.select) {
            params.AttributesToGet = core.strSplit(options.select);
        }
        <span class="keyword">if</span> (options.consistent) {
            params.ConsistentRead = <span class="literal">true</span>;
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> keys) {
            params.Key[p] = self.toDynamoDB(keys[p]);
        }
        <span class="keyword">this</span>.queryDDB(<span class="string">'GetItem'</span>, params, options, <span class="function"><span class="keyword">function</span><span class="params">(err, rc)</span> {</span>
            rc.Item = rc.Item ? self.fromDynamoDB(rc.Item) : {};
            <span class="keyword">if</span> (callback) callback(err, rc);
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Put or add an item</p>
<ul>
<li>item is an object, type will be inferred from the native js type.</li>
<li>options may contain any valid native property if it starts with capital letter or special properties:<ul>
<li>expected - an object with column names to be used in Expected clause and value as null to set condition to { Exists: false } or 
any other exact value to be checked against which corresponds to { Exists: true, Value: value }
Example: ddbPutItem(&quot;users&quot;, { id: 1, name: &quot;john&quot;, mtime: 11233434 }, { expected: { name: null } })</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ddbPutItem: <span class="function"><span class="keyword">function</span><span class="params">(name, item, options, callback)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = {};
        <span class="keyword">if</span> (!options) options = {};
        <span class="keyword">var</span> params = { TableName: name, Item: self.toDynamoDB(item) };
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> options) {
            <span class="keyword">if</span> (p[<span class="number">0</span>] &gt;= <span class="string">'A'</span> &amp;&amp; p[<span class="number">0</span>] &lt;= <span class="string">'Z'</span>) params[p] = options[p];
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Sugar-candy syntax for expected values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> options.expected) {
            <span class="keyword">if</span> (!params.Expected) params.Expected = {};
            <span class="keyword">if</span> (options.expected[p] == <span class="literal">null</span>) {
                params.Expected[p] = { Exists: <span class="literal">false</span> };
            } <span class="keyword">else</span> {
                params.Expected[p] = { Value: self.toDynamoDB(options.expected[p]) };
            }
        }
        <span class="keyword">this</span>.queryDDB(<span class="string">'PutItem'</span>, params, options, <span class="function"><span class="keyword">function</span><span class="params">(err, rc)</span> {</span>
            rc.Item = rc.Attributes ? self.fromDynamoDB(rc.Attributes) : {};
            <span class="keyword">if</span> (callback) callback(err, rc);
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Update an item</p>
<ul>
<li>keys is an object with primary key attributes name and value.</li>
<li>item is an object with properties where value can be:<ul>
<li>number/string/array - action PUT, replace or add new value</li>
<li>null - action DELETE</li>
</ul>
</li>
<li>options may contain any valid native property if it starts with capital letter or special properties:<ul>
<li>ops - an object with operators to be used for properties if other than PUT</li>
<li>expected - an object with column names to be used in Expected clause and value as null to set condition to { Exists: false } or 
any other exact value to be checked against which corresponds to { Exists: true, Value: value }
Example: ddbUpdateItem(&quot;users&quot;, { id: 1, name: &quot;john&quot; }, { gender: &#39;male&#39;, icons: &#39;1.png&#39; }, { op: { icons: &#39;ADD&#39; }, expected: { id: 1 } })</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ddbUpdateItem: <span class="function"><span class="keyword">function</span><span class="params">(name, keys, item, options, callback)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = {};
        <span class="keyword">if</span> (!options) options = {};
        <span class="keyword">var</span> params = { TableName: name, Key: {}, AttributeUpdates: {} };
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> options) {
            <span class="keyword">if</span> (p[<span class="number">0</span>] &gt;= <span class="string">'A'</span> &amp;&amp; p[<span class="number">0</span>] &lt;= <span class="string">'Z'</span>) params[p] = options[p];
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> keys) {
            params.Key[p] = self.toDynamoDB(keys[p]);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Sugar-candy syntax for expected values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> options.expected) {
            <span class="keyword">if</span> (!params.Expected) params.Expected = {};
            <span class="keyword">if</span> (options.expected[p] == <span class="literal">null</span>) {
                params.Expected[p] = { Exists: <span class="literal">false</span> };
            } <span class="keyword">else</span> {
                params.Expected[p] = { Value: self.toDynamoDB(options.expected[p]) };
            }
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> item) {
            <span class="keyword">if</span> (params.Key[p]) <span class="keyword">continue</span>;
            <span class="keyword">switch</span> (core.typeName(item[p])) {
                <span class="keyword">case</span> <span class="string">'null'</span>:
                <span class="keyword">case</span> <span class="string">'undefined'</span>:
                    params.AttributeUpdates[p] = { Action: <span class="string">'DELETE'</span> };
                    <span class="keyword">break</span>;
                    
                <span class="keyword">case</span> <span class="string">'array'</span>:
                    <span class="keyword">if</span> (!item[p].length) {
                        params.AttributeUpdates[p] = { Action: <span class="string">'DELETE'</span> };
                        <span class="keyword">break</span>;
                    }
                    
                <span class="keyword">default</span>:
                    params.AttributeUpdates[p] = { Action: (options.ops || {})[p] || <span class="string">'PUT'</span> };
                    <span class="keyword">if</span> (item[p]) params.AttributeUpdates[p].Value = self.toDynamoDB(item[p]);
                    <span class="keyword">break</span>;
            }
        }
        <span class="keyword">this</span>.queryDDB(<span class="string">'UpdateItem'</span>, params, options, <span class="function"><span class="keyword">function</span><span class="params">(err, rc)</span> {</span>
            rc.Item = rc.Attributes ? self.fromDynamoDB(rc.Attributes) : {};
            <span class="keyword">if</span> (callback) callback(err, rc);
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Delete an item from a table</p>
<ul>
<li>keys is an object with name: value for hash/range attributes</li>
<li>options may contain any valid native property if it starts with capital letter.
Example: ddbDeleteItem(&quot;users&quot;, { id: 1, name: &quot;john&quot; }, {})</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ddbDeleteItem: <span class="function"><span class="keyword">function</span><span class="params">(name, keys, options, callback)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = {};
        <span class="keyword">if</span> (!options) options = {};
        <span class="keyword">var</span> params = { TableName: name, Key: {} };
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> options) {
            <span class="keyword">if</span> (p[<span class="number">0</span>] &gt;= <span class="string">'A'</span> &amp;&amp; p[<span class="number">0</span>] &lt;= <span class="string">'Z'</span>) params[p] = options[p];
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> keys) {
            params.Key[p] = self.toDynamoDB(keys[p]);
        }
        <span class="keyword">this</span>.queryDDB(<span class="string">'DeleteItem'</span>, params, options, <span class="function"><span class="keyword">function</span><span class="params">(err, rc)</span> {</span>
            rc.Item = rc.Attributes ? self.fromDynamoDB(rc.Attributes) : {};
            <span class="keyword">if</span> (callback) callback(err, rc);
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Update items from the list at the same time</p>
<ul>
<li>items is a list of objects with table name as property and list of operations, an operation can be PutRequest or DeleteRequest</li>
<li>options may contain any valid native property if it starts with capital letter.
Example: { table: [ { PutRequest: { id: 1, name: &quot;tt&quot; } }, ] }</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ddbBatchWriteItem: <span class="function"><span class="keyword">function</span><span class="params">(items, options, callback)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = {};
        <span class="keyword">if</span> (!options) options = {};
        <span class="keyword">var</span> params = { RequestItems: {} };
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> options) {
            <span class="keyword">if</span> (p[<span class="number">0</span>] &gt;= <span class="string">'A'</span> &amp;&amp; p[<span class="number">0</span>] &lt;= <span class="string">'Z'</span>) params[p] = options[p];
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> items) {
            params.RequestItems[p] = [];
            items[p].forEach(<span class="function"><span class="keyword">function</span><span class="params">(x)</span> {</span>
                <span class="keyword">var</span> obj = {};
                <span class="keyword">for</span> (<span class="keyword">var</span> m <span class="keyword">in</span> x) {
                    obj[m] = { Item: self.toDynamoDB(x[m]) };
                }
                params.RequestItems[p].push(obj);
            });
        }
        <span class="keyword">this</span>.queryDDB(<span class="string">'BatchWriteItem'</span>, params, options, <span class="function"><span class="keyword">function</span><span class="params">(err, rc)</span> {</span>
            rc.Item = rc.Attributes ? self.fromDynamoDB(rc.Attributes) : {};
            <span class="keyword">if</span> (callback) callback(err, rc);
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Retrieve all items for given list of keys</p>
<ul>
<li>items is list of objects with table name as property name and list of options for GetItem request</li>
<li>options may contain any valid native property if it starts with capital letter.
Example: { users: [ { keys: { id: 1, name: &quot;john&quot; }, select: [&#39;name&#39;,&#39;id&#39;], consistent: true }, ...] }</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ddbBatchGetItem: <span class="function"><span class="keyword">function</span><span class="params">(items, options, callback)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = {};
        <span class="keyword">if</span> (!options) options = {};
        <span class="keyword">var</span> params = { RequestItems: {} };
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> options) {
            <span class="keyword">if</span> (p[<span class="number">0</span>] &gt;= <span class="string">'A'</span> &amp;&amp; p[<span class="number">0</span>] &lt;= <span class="string">'Z'</span>) params[p] = options[p];
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> items) {
            <span class="keyword">if</span> (!params.RequestItems[p]) params.RequestItems[p] = [];
            items[p].forEach(<span class="function"><span class="keyword">function</span><span class="params">(x)</span> {</span>
                <span class="keyword">var</span> obj = {};
                obj.Keys = self.toDynamoDB(obj.keys);
                <span class="keyword">if</span> (x.select) obj.AttributesToGet = core.strSplit(x.select);
                <span class="keyword">if</span> (x.consistent) obj.ConsistentRead = <span class="literal">true</span>;
                params.RequestItems[p].push(obj);
            });
        }
        <span class="keyword">this</span>.queryDDB(<span class="string">'BatchGetItem'</span>, params, options, <span class="function"><span class="keyword">function</span><span class="params">(err, rc)</span> {</span>
            rc.Responses = rc.Responses ? self.fromDynamoDB(rc.Responses) : [];
            <span class="keyword">if</span> (callback) callback(err, rc);
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Query on a table, return all matching items</p>
<ul>
<li>condition is an object with name: value pairs, by default EQ opeartor is used for comparison</li>
<li>options may contain any valid native property if it starts with capital letter or special property:<ul>
<li>start - defines starting primary key when paginating, can be a string/number for hash or an object with hash/range properties</li>
<li>consistent - set consistency level for the request</li>
<li>select - list of attributes to get only</li>
<li>total - return number of matching records</li>
<li>count - limit number of record in result</li>
<li>desc - descending order</li>
<li>sort - index name to use, indexes are named the same as the corresponding column</li>
<li>ops - an object with operators to be used for properties if other than EQ.
Example: ddbQueryTable(&quot;users&quot;, { id: 1, name: &quot;john&quot; }, { select: &#39;id,name&#39;, op: { name: &#39;gt&#39; } })</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ddbQueryTable: <span class="function"><span class="keyword">function</span><span class="params">(name, condition, options, callback)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = {};
        <span class="keyword">if</span> (!options) options = {};
        <span class="keyword">var</span> params = { TableName: name, KeyConditions: {} };
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> options) {
            <span class="keyword">if</span> (p[<span class="number">0</span>] &gt;= <span class="string">'A'</span> &amp;&amp; p[<span class="number">0</span>] &lt;= <span class="string">'Z'</span>) params[p] = options[p];
        }
        <span class="keyword">if</span> (options.consistent) {
            params.ConsistentRead = <span class="literal">true</span>;
        }
        <span class="keyword">if</span> (options.start) {
            params.ExclusiveStartKey = self.toDynamoDB(options.start);
        }
        <span class="keyword">if</span> (options.sort) {
            params.IndexName = options.sort;
        }
        <span class="keyword">if</span> (options.desc) {
            params.ScanIndexForward = <span class="literal">false</span>;
        }
        <span class="keyword">if</span> (options.select) {
            params.AttributesToGet = core.strSplit(options.select);
        }
        <span class="keyword">if</span> (options.count) {
            params.Limit = options.count;
        }
        <span class="keyword">if</span> (options.total) {
            params.Select = <span class="string">"COUNT"</span>;
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> name <span class="keyword">in</span> condition) {
            <span class="keyword">var</span> val = condition[name];
            <span class="keyword">var</span> op = (options.ops || {})[name] || <span class="string">"eq"</span>;
            <span class="keyword">if</span> (<span class="keyword">this</span>.opMap[op]) op = <span class="keyword">this</span>.opMap[op];
            <span class="keyword">var</span> cond = { AttributeValueList: [], ComparisonOperator: op.toUpperCase() }
            <span class="keyword">switch</span> (cond.ComparisonOperator) {
            <span class="keyword">case</span> <span class="string">'BETWEEN'</span>:
                <span class="keyword">if</span> (args.length &lt; <span class="number">2</span>) <span class="keyword">continue</span>;
                cond.AttributeValueList.push(self.toDynamoDB(val[<span class="number">0</span>]));
                cond.AttributeValueList.push(self.toDynamoDB(val[<span class="number">1</span>]));
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'EQ'</span>:
            <span class="keyword">case</span> <span class="string">'LE'</span>:
            <span class="keyword">case</span> <span class="string">'LT'</span>:
            <span class="keyword">case</span> <span class="string">'GE'</span>:
            <span class="keyword">case</span> <span class="string">'GT'</span>:
            <span class="keyword">case</span> <span class="string">'BEGINS_WITH'</span>:
                cond.AttributeValueList.push(self.toDynamoDB(val));
                <span class="keyword">break</span>;
            }
            params.KeyConditions[name] = cond;
        }
        <span class="keyword">this</span>.queryDDB(<span class="string">'Query'</span>, params, options, <span class="function"><span class="keyword">function</span><span class="params">(err, rc)</span> {</span>
            rc.Items = rc.Items ? self.fromDynamoDB(rc.Items) : [];
            <span class="keyword">if</span> (callback) callback(err, rc);
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Scan a table for all matching items</p>
<ul>
<li>condition is an object with name: value pairs</li>
<li>options may contain any valid native property if it starts with capital letter or special property:<ul>
<li>start - defines starting primary key</li>
<li>ops - an object with operators to be used for properties if other than EQ.
Example: ddbScanTable(&quot;users&quot;, { id: 1, name: &#39;a&#39; }, { op: { name: &#39;gt&#39; }})</li>
</ul>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ddbScanTable: <span class="function"><span class="keyword">function</span><span class="params">(name, condition, options, callback)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = {};
        <span class="keyword">if</span> (!options) options = {};
        <span class="keyword">var</span> params = { TableName: name, ScanFilter: {} };
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> options) {
            <span class="keyword">if</span> (p[<span class="number">0</span>] &gt;= <span class="string">'A'</span> &amp;&amp; p[<span class="number">0</span>] &lt;= <span class="string">'Z'</span>) params[p] = options[p];
        }
        <span class="keyword">if</span> (options.start) {
            params.ExclusiveStartKey = self.toDynamoDB(options.start);
        }
        <span class="keyword">for</span> (<span class="keyword">var</span> name <span class="keyword">in</span> condition) {
            <span class="keyword">var</span> val = condition[name];
            <span class="keyword">var</span> op = (options.ops || {})[name] || <span class="string">"eq"</span>;
            <span class="keyword">if</span> (<span class="keyword">this</span>.opMap[op]) op = <span class="keyword">this</span>.opMap[op];
            <span class="keyword">var</span> cond = { AttributeValueList: [], ComparisonOperator: op.toUpperCase() }
            <span class="keyword">switch</span> (cond.ComparisonOperator) {
            <span class="keyword">case</span> <span class="string">'BETWEEN'</span>:
                <span class="keyword">if</span> (args.length &lt; <span class="number">2</span>) <span class="keyword">continue</span>;
                cond.AttributeValueList.push(self.toDynamoDB(val[<span class="number">0</span>]));
                cond.AttributeValueList.push(self.toDynamoDB(val[<span class="number">1</span>]));
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'EQ'</span>:
            <span class="keyword">case</span> <span class="string">'LE'</span>:
            <span class="keyword">case</span> <span class="string">'LT'</span>:
            <span class="keyword">case</span> <span class="string">'GE'</span>:
            <span class="keyword">case</span> <span class="string">'GT'</span>:
            <span class="keyword">case</span> <span class="string">'BEGINS_WITH'</span>:
                cond.AttributeValueList.push(self.toDynamoDB(val));
                <span class="keyword">break</span>;
            }
            params.ScanFilter[name] = cond;
        }
        <span class="keyword">this</span>.queryDDB(<span class="string">'Scan'</span>, params, options, <span class="function"><span class="keyword">function</span><span class="params">(err, rc)</span> {</span>
            rc.Items = rc.Items ? self.fromDynamoDB(rc.Items) : [];
            <span class="keyword">if</span> (callback) callback(err, rc);
        });
    },

}

module.exports = aws;
core.addContext(<span class="string">'aws'</span>, aws);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
