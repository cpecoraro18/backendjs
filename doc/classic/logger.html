<!DOCTYPE html>

<html>
<head>
  <title>logger.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="api.html">
                api.js
              </a>
            
              
              <a class="source" href="aws.html">
                aws.js
              </a>
            
              
              <a class="source" href="core.html">
                core.js
              </a>
            
              
              <a class="source" href="db.html">
                db.js
              </a>
            
              
              <a class="source" href="index.html">
                index.js
              </a>
            
              
              <a class="source" href="logger.html">
                logger.js
              </a>
            
              
              <a class="source" href="server.html">
                server.js
              </a>
            
              
              <a class="source" href="tests.html">
                tests.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>logger.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p> Author: Vlad Seryakov vseryakov@gmail.com
 Sep 2013</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> util = require(<span class="string">'util'</span>);
<span class="keyword">var</span> fs = require(<span class="string">'fs'</span>);
<span class="keyword">var</span> backend = require(__dirname + <span class="string">'/backend'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Simple logger utility for debugging</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> logger = {
    level: <span class="number">0</span>,
    file: <span class="literal">null</span>,
    stream: process.stdout,
    writable: <span class="literal">true</span>,
    levels: { test: <span class="number">3</span>, dev: <span class="number">2</span>, debug: <span class="number">1</span>, warn: <span class="number">0</span>, info: <span class="number">0</span>, none: -<span class="number">1</span> },</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>syslog facilities</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    LOG_KERN: (<span class="number">0</span>&lt;&lt;<span class="number">3</span>),
    LOG_USER: (<span class="number">1</span>&lt;&lt;<span class="number">3</span>),
    LOG_MAIL: (<span class="number">2</span>&lt;&lt;<span class="number">3</span>),
    LOG_DAEMON: (<span class="number">3</span>&lt;&lt;<span class="number">3</span>),
    LOG_AUTH: (<span class="number">4</span>&lt;&lt;<span class="number">3</span>),
    LOG_SYSLOG: (<span class="number">5</span>&lt;&lt;<span class="number">3</span>),
    LOG_LPR: (<span class="number">6</span>&lt;&lt;<span class="number">3</span>),
    LOG_NEWS: (<span class="number">7</span>&lt;&lt;<span class="number">3</span>),
    LOG_UUCP: (<span class="number">8</span>&lt;&lt;<span class="number">3</span>),
    LOG_CRON:  (<span class="number">9</span>&lt;&lt;<span class="number">3</span>),
    LOG_AUTHPRIV: (<span class="number">10</span>&lt;&lt;<span class="number">3</span>),
    LOG_FTP: (<span class="number">11</span>&lt;&lt;<span class="number">3</span>),
    LOG_LOCAL0: (<span class="number">16</span>&lt;&lt;<span class="number">3</span>),
    LOG_LOCAL1: (<span class="number">17</span>&lt;&lt;<span class="number">3</span>),
    LOG_LOCAL2: (<span class="number">18</span>&lt;&lt;<span class="number">3</span>),
    LOG_LOCAL3: (<span class="number">19</span>&lt;&lt;<span class="number">3</span>),
    LOG_LOCAL4: (<span class="number">20</span>&lt;&lt;<span class="number">3</span>),
    LOG_LOCAL5: (<span class="number">21</span>&lt;&lt;<span class="number">3</span>),
    LOG_LOCAL6: (<span class="number">22</span>&lt;&lt;<span class="number">3</span>),
    LOG_LOCAL7: (<span class="number">23</span>&lt;&lt;<span class="number">3</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>syslog options for openlog</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    LOG_PID: <span class="number">0x01</span>,
    LOG_CONS: <span class="number">0x02</span>,
    LOG_ODELAY: <span class="number">0x04</span>,
    LOG_NDELAY: <span class="number">0x08</span>,
    LOG_NOWAIT: <span class="number">0x10</span>,
    LOG_PERROR: <span class="number">0x20</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>syslog priorities</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    LOG_EMERG: <span class="number">0</span>,
    LOG_ALERT: <span class="number">1</span>,
    LOG_CRIT: <span class="number">2</span>,
    LOG_ERROR: <span class="number">3</span>,
    LOG_WARNING: <span class="number">4</span>,
    LOG_NOTICE: <span class="number">5</span>,
    LOG_INFO: <span class="number">6</span>,
    LOG_DEBUG: <span class="number">7</span>,

    syslogMap: {},
    syslogLevels: {},
    syslogFacilities: {},

    pad: <span class="function"><span class="keyword">function</span><span class="params">(n)</span> {</span>
        <span class="keyword">if</span> (n &gt;= <span class="number">0</span> &amp;&amp; n &lt; <span class="number">10</span>) <span class="keyword">return</span> <span class="string">"0"</span> + n
        <span class="keyword">return</span> n
    },

    prefix: <span class="function"><span class="keyword">function</span><span class="params">(level)</span> {</span>
        <span class="keyword">var</span> d = <span class="keyword">new</span> Date()
        <span class="keyword">return</span> d.getFullYear() + <span class="string">"-"</span> +
               <span class="keyword">this</span>.pad(d.getMonth()+<span class="number">1</span>) + <span class="string">"-"</span> +
               <span class="keyword">this</span>.pad(d.getDate()) + <span class="string">" "</span> +
               <span class="keyword">this</span>.pad(d.getHours()) + <span class="string">":"</span> +
               <span class="keyword">this</span>.pad(d.getMinutes()) + <span class="string">":"</span> +
               <span class="keyword">this</span>.pad(d.getSeconds()) + <span class="string">"."</span> +
               <span class="keyword">this</span>.pad(d.getMilliseconds()) +
               <span class="string">" ["</span> + process.pid + <span class="string">"] "</span> +
               level + <span class="string">": "</span>
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Set or close syslog mode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setSyslog: <span class="function"><span class="keyword">function</span> <span class="params">(on)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">if</span> (on) {
            backend.syslogInit(<span class="string">"backend"</span>, <span class="keyword">this</span>.LOG_PID | <span class="keyword">this</span>.LOG_CONS, <span class="keyword">this</span>.LOG_LOCAL0);
            <span class="keyword">this</span>.print = <span class="keyword">this</span>.printSyslog;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Initialize map for facilities</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">this</span>.syslogLevels = { test: <span class="keyword">this</span>.LOG_DEBUG, dev: <span class="keyword">this</span>.LOG_DEBUG, debug: <span class="keyword">this</span>.LOG_DEBUG, warn: <span class="keyword">this</span>.LOG_WARNING,
                                  notice: <span class="keyword">this</span>.LOG_NOTICE, info: <span class="keyword">this</span>.LOG_INFO, error: <span class="keyword">this</span>.LOG_ERROR,
                                  emerg: <span class="keyword">this</span>.LOG_EMERG, alert: <span class="keyword">this</span>.LOG_ALERT, crit: <span class="keyword">this</span>.LOG_CRIT };
            <span class="keyword">this</span>.syslogFacilities = { kern: <span class="keyword">this</span>.LOG_KERN, user: <span class="keyword">this</span>.LOG_USER, mail: <span class="keyword">this</span>.LOG_MAIL,
                                      daemon: <span class="keyword">this</span>.LOG_DAEMON, auth: <span class="keyword">this</span>.LOG_AUTH, syslog: <span class="keyword">this</span>.LOG_SYSLOG,
                                      lpr: <span class="keyword">this</span>.LOG_LPR, news: <span class="keyword">this</span>.LOG_NEWS, uucp: <span class="keyword">this</span>.LOG_UUCP,
                                      cron: <span class="keyword">this</span>.LOG_CRON, authpriv: <span class="keyword">this</span>.LOG_AUTHPRIV,
                                      ftp: <span class="keyword">this</span>.LOG_FTP, local0: <span class="keyword">this</span>.LOG_LOCAL0, local1: <span class="keyword">this</span>.LOG_LOCAL1,
                                      locl2: <span class="keyword">this</span>.LOG_LOCAL2, local3: <span class="keyword">this</span>.LOG_LOCAL3, local4: <span class="keyword">this</span>.LOG_LOCAL4,
                                      local5: <span class="keyword">this</span>.LOG_LOCAL5, local6: <span class="keyword">this</span>.LOG_LOCAL6, local7: <span class="keyword">this</span>.LOG_LOCAL7 };
            <span class="keyword">this</span>.syslogMap = {}
            Object.keys(<span class="keyword">this</span>.syslogLevels).forEach(<span class="function"><span class="keyword">function</span><span class="params">(l)</span> {</span>
               Object.keys(self.syslogFacilities).forEach(<span class="function"><span class="keyword">function</span><span class="params">(f)</span> {</span>
                   self.syslogMap[l + <span class="string">':'</span> + f] = self.syslogLevels[l] | self.syslogFacilities[f];
               });
            });
        } <span class="keyword">else</span> {
            backend.syslogClose();
            <span class="keyword">this</span>.print = <span class="keyword">this</span>.printStream;
        }
        <span class="keyword">this</span>.syslog = on;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Redirect logging into file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setFile: <span class="function"><span class="keyword">function</span><span class="params">(file)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">if</span> (<span class="keyword">this</span>.stream &amp;&amp; <span class="keyword">this</span>.stream != process.stdout) {
            <span class="keyword">this</span>.stream.destroySoon();
        }
        <span class="keyword">this</span>.file = file;
        <span class="keyword">if</span> (<span class="keyword">this</span>.file) {
            <span class="keyword">this</span>.stream = fs.createWriteStream(<span class="keyword">this</span>.file, { flags: <span class="string">'a'</span> });
            <span class="keyword">this</span>.stream.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span><span class="params">(err)</span> {</span>
                process.stderr.write(String(err));
                self.stream = process.stderr;
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Make sure the log file is owned by regular user to avoid crashes due to no permission of the log file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (process.getuid() == <span class="number">0</span>) {
                fs.chown(file, core.uid, core.gid, <span class="function"><span class="keyword">function</span><span class="params">(err)</span> {</span> self.error(file, e) });
            }
        } <span class="keyword">else</span> {
            <span class="keyword">this</span>.stream = process.stdout;
        }
    },

    setDebug: <span class="function"><span class="keyword">function</span><span class="params">(level)</span> {</span>
        <span class="keyword">this</span>.level = <span class="keyword">typeof</span> <span class="keyword">this</span>.levels[level] != <span class="string">"undefined"</span> ? <span class="keyword">this</span>.levels[level] : isNaN(parseInt(level)) ? <span class="number">0</span> : parseInt(level);
        backend.logging(<span class="keyword">this</span>.level + <span class="number">2</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Assign output channel to system logger, default is stdout</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setChannel: <span class="function"><span class="keyword">function</span><span class="params">(name)</span> {</span>
        backend.loggingChannel(name);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>syslog allows facility to be specified after log level like info:local0 for LOG_LOCAL0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    printSyslog: <span class="function"><span class="keyword">function</span><span class="params">(level, msg)</span> {</span>
        <span class="keyword">var</span> code = <span class="keyword">this</span>.syslogMap[level];
        backend.syslogSend(code || <span class="keyword">this</span>.LOG_INFO, (code ? <span class="string">""</span> : level + <span class="string">": "</span>) + msg);
    },

    printStream: <span class="function"><span class="keyword">function</span><span class="params">(level, msg)</span> {</span>
        <span class="keyword">this</span>.stream.write(<span class="keyword">this</span>.prefix(level) + msg + <span class="string">"\n"</span>);
    },

    printError: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        process.stderr.write(<span class="keyword">this</span>.prefix(<span class="string">"ERROR"</span>) + util.format.apply(<span class="keyword">this</span>, arguments).replace(<span class="regexp">/[ \r\n\t]+/g</span>, <span class="string">" "</span>) + <span class="string">"\n"</span>);
    },

    log: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">this</span>.level &lt; <span class="number">0</span>) <span class="keyword">return</span>;
        <span class="keyword">this</span>.print(<span class="string">'INFO'</span>, util.format.apply(<span class="keyword">this</span>, arguments).replace(<span class="regexp">/[ \r\n\t]+/g</span>, <span class="string">" "</span>));
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Make it one line to preserve space, syslog cannot output very long lines</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    debug: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">this</span>.level &lt; <span class="number">1</span>) <span class="keyword">return</span>;
        <span class="keyword">var</span> str = <span class="string">""</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span>  arguments) str += util.inspect(arguments[p], { depth: <span class="literal">null</span> }) + <span class="string">" "</span>;
        <span class="keyword">this</span>.print(<span class="string">'DEBUG'</span>, str.replace(<span class="regexp">/\\n/g</span>,<span class="string">' '</span>).replace(<span class="regexp">/[ \\\r\n\t]+/g</span>, <span class="string">" "</span>));
    },

    dev: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">this</span>.level &lt; <span class="number">2</span>) <span class="keyword">return</span>;
        <span class="keyword">var</span> str = <span class="string">""</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span>  arguments) str += util.inspect(arguments[p], { depth: <span class="literal">null</span> }) + <span class="string">" "</span>;
        <span class="keyword">this</span>.print(<span class="string">'DEV'</span>, str.replace(<span class="regexp">/\\n/g</span>,<span class="string">' '</span>).replace(<span class="regexp">/[ \\\r\n\t]+/g</span>, <span class="string">" "</span>));
    },

    warn: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">this</span>.level &lt; <span class="number">0</span>) <span class="keyword">return</span>;
        <span class="keyword">this</span>.print(<span class="string">'WARNING'</span>, util.format.apply(<span class="keyword">this</span>, arguments).replace(<span class="regexp">/[ \r\n\t]+/g</span>, <span class="string">" "</span>));
    },

    error: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.print(<span class="string">'ERROR'</span>, util.format.apply(<span class="keyword">this</span>, arguments).replace(<span class="regexp">/[ \r\n\t]+/g</span>, <span class="string">" "</span>));
    },

    dump: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.stream.write(util.format.apply(<span class="keyword">this</span>, arguments).replace(<span class="regexp">/[ \r\n\t]+/g</span>, <span class="string">" "</span>) + <span class="string">"\n"</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Display error if first argument is an Error object or debug</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    edebug: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> args = Array.prototype.slice.call(arguments, <span class="number">1</span>)
        <span class="keyword">if</span> (arguments[<span class="number">0</span>] <span class="keyword">instanceof</span> Error) <span class="keyword">return</span> <span class="keyword">this</span>.error.apply(<span class="keyword">this</span>, arguments);
        <span class="keyword">this</span>.debug.apply(<span class="keyword">this</span>, args);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Display error if first argument is an Error object or log</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    elog: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> args = Array.prototype.slice.call(arguments, <span class="number">1</span>)
        <span class="keyword">if</span> (arguments[<span class="number">0</span>] <span class="keyword">instanceof</span> Error) <span class="keyword">return</span> <span class="keyword">this</span>.error.apply(<span class="keyword">this</span>, arguments);
        <span class="keyword">this</span>.log.apply(<span class="keyword">this</span>, args);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Print stack backtrace as error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    trace: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> err = <span class="keyword">new</span> Error(<span class="string">''</span>);
        err.name = <span class="string">'Trace'</span>;
        Error.captureStackTrace(err, arguments.callee);
        <span class="keyword">this</span>.error(util.format.apply(<span class="keyword">this</span>, arguments), err.stack);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Default write handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    print: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">this</span>.printStream.apply(<span class="keyword">this</span>, arguments);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Stream emulation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    write: <span class="function"><span class="keyword">function</span><span class="params">(str)</span> {</span>
        <span class="keyword">if</span> (str) <span class="keyword">this</span>.log(str);
        <span class="keyword">return</span> <span class="literal">true</span>;
    },

    end: <span class="function"><span class="keyword">function</span><span class="params">(str)</span> {</span>
        <span class="keyword">if</span> (str) <span class="keyword">this</span>.log(str);
    }
}

module.exports = logger;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
