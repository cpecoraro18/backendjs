<!DOCTYPE html>

<html>
<head>
  <title>server.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>server.js</h1>
        

        
          <div class="toc">
            <h3>Table of Contents</h3>
            <ol>
              
                
                <li>
                  <a class="source" href="api.html">
                    api.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="aws.html">
                    aws.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="core.html">
                    core.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="db.html">
                    db.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="index.html">
                    index.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="logger.html">
                    logger.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="server.html">
                    server.js
                  </a>
                </li>
              
                
                <li>
                  <a class="source" href="tests.html">
                    tests.js
                  </a>
                </li>
              
            </ol>
          </div>
        
      </div>

      
        
        <p> Author: Vlad Seryakov vseryakov@gmail.com
 Sep 2013</p>

        
          <div class='highlight'><pre><span class="keyword">var</span> net = require(<span class="string">'net'</span>);
<span class="keyword">var</span> cluster = require(<span class="string">'cluster'</span>);
<span class="keyword">var</span> cron = require(<span class="string">'cron'</span>);
<span class="keyword">var</span> path = require(<span class="string">'path'</span>);
<span class="keyword">var</span> util = require(<span class="string">'util'</span>);
<span class="keyword">var</span> fs = require(<span class="string">'fs'</span>);
<span class="keyword">var</span> spawn = require(<span class="string">'child_process'</span>).spawn;
<span class="keyword">var</span> exec = require(<span class="string">'child_process'</span>).exec;
<span class="keyword">var</span> core = require(__dirname + <span class="string">'/core'</span>);
<span class="keyword">var</span> logger = require(__dirname + <span class="string">'/logger'</span>);
<span class="keyword">var</span> db = require(__dirname + <span class="string">'/db'</span>);
<span class="keyword">var</span> aws = require(__dirname + <span class="string">'/aws'</span>);
<span class="keyword">var</span> os = require(<span class="string">'os'</span>);
<span class="keyword">var</span> stream = require(<span class="string">'stream'</span>);
<span class="keyword">var</span> async = require(<span class="string">'async'</span>);
<span class="keyword">var</span> printf = require(<span class="string">'printf'</span>);
<span class="keyword">var</span> proxy = require(<span class="string">'http-proxy'</span>);

<span class="keyword">var</span> server = {</pre></div>
        
      
        
        <p>Watcher process status</p>

        
          <div class='highlight'><pre>    child: <span class="literal">null</span>,</pre></div>
        
      
        
        <p>Aditional processes to kill on exit</p>

        
          <div class='highlight'><pre>    pids: [],
    exiting: <span class="literal">false</span>,</pre></div>
        
      
        
        <p>Delay (ms) before restarting the server</p>

        
          <div class='highlight'><pre>    restartDelay: <span class="number">2000</span>,</pre></div>
        
      
        
        <p>Redefined in case of log file</p>

        
          <div class='highlight'><pre>    stdout: <span class="literal">null</span>,
    stderr: <span class="literal">null</span>,</pre></div>
        
      
        
        <p>Crash throttling</p>

        
          <div class='highlight'><pre>    crashInterval: <span class="number">3000</span>, 
    crashDelay: <span class="number">30000</span>, 
    crashCount: <span class="number">3</span>, 
    crashTime: <span class="literal">null</span>, 
    crashEvents: <span class="number">0</span>,</pre></div>
        
      
        
        <p>Job waiting for the next avaialble worker</p>

        
          <div class='highlight'><pre>    queue: [],</pre></div>
        
      
        
        <p>List of jobs a worker is running or all jobs running</p>

        
          <div class='highlight'><pre>    jobs: [],</pre></div>
        
      
        
        <p>Time of the last update on jobs and workers</p>

        
          <div class='highlight'><pre>    jobTime: <span class="number">0</span>,</pre></div>
        
      
        
        <p>Schedules cron jobs</p>

        
          <div class='highlight'><pre>    crontab: [],</pre></div>
        
      
        
        <p>Filter to allow only subset of jobs to run, regex</p>

        
          <div class='highlight'><pre>    jobsAllow: <span class="literal">null</span>,
    jobsDisallow: <span class="literal">null</span>,
    jobsInterval: <span class="number">180000</span>,</pre></div>
        
      
        
        <p>Number of workers or web servers to launch</p>

        
          <div class='highlight'><pre>    maxWorkers: <span class="number">1</span>,
    maxProcesses: <span class="number">1</span>,</pre></div>
        
      
        
        <p>How long to be in idle state and shutdown, for use in instances</p>

        
          <div class='highlight'><pre>    idleTime: <span class="number">120</span>,</pre></div>
        
      
        
        <p>Config parameters</p>

        
          <div class='highlight'><pre>    args: [{ name: <span class="string">"max-processes"</span>, type: <span class="string">"number"</span>, min: <span class="number">1</span>, max: <span class="number">4</span>, descr: <span class="string">"Max processes to launch for servers"</span> }, 
           { name: <span class="string">"max-workers"</span>, type: <span class="string">"number"</span>, min: <span class="number">1</span>, max: <span class="number">4</span>, descr: <span class="string">"Max number of worker processes to launch for jobs"</span> }, 
           { name: <span class="string">"idle-time"</span>, type: <span class="string">"number"</span>, descr: <span class="string">"If set and no jobs are submitted the backend will be shutdown, for instance mode only"</span> }, 
           { name: <span class="string">"crash-delay"</span>, type: <span class="string">"number"</span>, max: <span class="number">30000</span>, descr: <span class="string">"Delay between respawing the crashed process"</span> }, 
           { name: <span class="string">"restart-delay"</span>, type: <span class="string">"number"</span>, max: <span class="number">30000</span>, descr: <span class="string">"Delay between respawning the server after changes"</span> },
           { name: <span class="string">"job"</span>, type: <span class="string">"callback"</span>, value: <span class="string">"queueJob"</span>, descr: <span class="string">"Job specification, JSON encoded as base64 of the job object"</span> },
           { name: <span class="string">"jobs-primary"</span>, type: <span class="string">"bool"</span>, descr: <span class="string">"If specified this host executes jobs without the hostname, otherwise only jobs with matching hostname will be executed by this server"</span> },
           { name: <span class="string">"jobs-interval"</span>, type: <span class="string">"number"</span>, min: <span class="number">60000</span>, max: <span class="number">900000</span>, descr: <span class="string">"Interval between executing job queue"</span> },
           { name: <span class="string">"jobs-allow"</span>, type: <span class="string">"regexp"</span>, descr: <span class="string">"Regexp allowing jobs to be executed in format: type.job where type is: local,remote,server"</span> },
           { name: <span class="string">"jobs-disallow"</span>, type: <span class="string">"regexp"</span>, descr: <span class="string">"Regexp disallowing jobs to be executed in format: type.job where type is: local,remote,server"</span> }],</pre></div>
        
      
        
        <p>Start the server process</p>

        
          <div class='highlight'><pre>    start: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;</pre></div>
        
      
        
        <p>Parse all params and load config file</p>

        
          <div class='highlight'><pre>        core.init(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> 
            process.title = core.name + <span class="string">": process"</span>;</pre></div>
        
      
        
        <p>REPL shell</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span> (process.argv.indexOf(<span class="string">"-shell"</span>) &gt; <span class="number">0</span>) {
                <span class="keyword">return</span> core.createRepl();
            }</pre></div>
        
      
        
        <p>Go to background</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span> (process.argv.indexOf(<span class="string">"-daemon"</span>) &gt; <span class="number">0</span>) {
                self.startDaemon();
            }</pre></div>
        
      
        
        <p>Graceful shutdown, kill all children processes</p>

        
          <div class='highlight'><pre>            process.once(<span class="string">'exit'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                self.exiting = <span class="literal">true</span>;
                <span class="keyword">if</span> (self.child) self.child.kill(<span class="string">'SIGTERM'</span>);
                self.pids.forEach(<span class="function"><span class="keyword">function</span><span class="params">(p)</span> {</span> process.kill(p) });
            });
            
            process.once(<span class="string">'SIGTERM'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                self.exiting = <span class="literal">true</span>;
                process.exit(<span class="number">0</span>);
            });</pre></div>
        
      
        
        <p>Watch monitor for modified source files</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span> (process.argv.indexOf(<span class="string">"-watch"</span>) &gt; <span class="number">0</span>) {
                self.startWatcher();
            } <span class="keyword">else</span></pre></div>
        
      
        
        <p>Start server monitor, it will watch the process and restart automatically</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span> (process.argv.indexOf(<span class="string">"-monitor"</span>) &gt; <span class="number">0</span>) {
                self.startMonitor();
            } <span class="keyword">else</span></pre></div>
        
      
        
        <p>Master server</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span> (process.argv.indexOf(<span class="string">"-master"</span>) &gt; <span class="number">0</span>) {
                core.initModules(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> self.startMaster(); });
            } <span class="keyword">else</span></pre></div>
        
      
        
        <p>Backend Web server</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span> (process.argv.indexOf(<span class="string">"-web"</span>) &gt; <span class="number">0</span>) {
                self.startWeb();
            } <span class="keyword">else</span></pre></div>
        
      
        
        <p>HTTP proxy</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span> (process.argv.indexOf(<span class="string">"-proxy"</span>) &gt; <span class="number">0</span>) {
                self.startProxy();
            }
        });
    },</pre></div>
        
      
        
        <p>Start process monitor, running as root</p>

        
          <div class='highlight'><pre>    startMonitor: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        process.title = core.name + <span class="string">': monitor'</span>;
        core.role = <span class="string">'monitor'</span>;

        <span class="keyword">this</span>.startProcess();</pre></div>
        
      
        
        <p>Monitor server tasks</p>

        
          <div class='highlight'><pre>        setInterval(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">try</span> {
                core.watchLogs();
            } <span class="keyword">catch</span>(e) {
                logger.error(<span class="string">'monitor:'</span>, e);
            }
        }, <span class="number">300000</span>);
    },</pre></div>
        
      
        
        <p>Setup worker environment</p>

        
          <div class='highlight'><pre>    startMaster: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;</pre></div>
        
      
        
        <p>Mark the time we started for calculating idle times properly</p>

        
          <div class='highlight'><pre>        self.jobTime = core.now();

        <span class="keyword">if</span> (cluster.isMaster) {
            core.role = <span class="string">'master'</span>;
            process.title = core.name + <span class="string">': master'</span>;</pre></div>
        
      
        
        <p>Start other master processes</p>

        
          <div class='highlight'><pre>            <span class="keyword">this</span>.startWebProcess();
            <span class="keyword">this</span>.startWebProxy();</pre></div>
        
      
        
        <p>REPL command prompt over TCP</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span> (core.argv.indexOf(<span class="string">"-repl"</span>) &gt; <span class="number">0</span>) self.startRepl(core.replPort, core.replBind);</pre></div>
        
      
        
        <p>Setup background tasks</p>

        
          <div class='highlight'><pre>            <span class="keyword">this</span>.loadSchedules();</pre></div>
        
      
        
        <p>Watch config directory for changes</p>

        
          <div class='highlight'><pre>            fs.watch(core.path.etc, <span class="function"><span class="keyword">function</span> <span class="params">(event, filename)</span> {</span>
                logger.debug(<span class="string">'watcher:'</span>, event, filename);
                <span class="keyword">switch</span> (filename) {
                <span class="keyword">case</span> <span class="string">"crontab"</span>:
                    core.setTimeout(filename, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> self.loadSchedules(); }, <span class="number">5000</span>);
                    <span class="keyword">break</span>;
                }
            });</pre></div>
        
      
        
        <p>Maintenance tasks</p>

        
          <div class='highlight'><pre>            setInterval(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></pre></div>
        
      
        
        <p>Submit pending jobs</p>

        
          <div class='highlight'><pre>                self.execQueue();</pre></div>
        
      
        
        <p>Check idle time, if no jobs running for a long time shutdown the server, this is for instance mode mostly</p>

        
          <div class='highlight'><pre>                <span class="keyword">if</span> (core.instance &amp;&amp; self.idleTime &gt; <span class="number">0</span> &amp;&amp; !Object.keys(cluster.workers).length &amp;&amp; core.now() - self.jobTime &gt; self.idleTime) {
                    logger.log(<span class="string">'startMaster:'</span>, <span class="string">'idle:'</span>, self.idleTime);
                    self.shutdown();
                }
            }, <span class="number">30000</span>);</pre></div>
        
      
        
        <p>Primary jobs</p>

        
          <div class='highlight'><pre>            setInterval(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> self.processJobs() }, self.jobsInterval);

            logger.log(<span class="string">'startMaster:'</span>, <span class="string">'version:'</span>, core.version, <span class="string">'home:'</span>, core.home, <span class="string">'port:'</span>, core.port, <span class="string">'uid:'</span>, process.getuid(), <span class="string">'gid:'</span>, process.getgid(), <span class="string">'pid:'</span>, process.pid)
        } <span class="keyword">else</span> {
            core.role = <span class="string">'worker'</span>;
            process.title = core.name + <span class="string">': worker'</span>;

            process.on(<span class="string">"message"</span>, <span class="function"><span class="keyword">function</span><span class="params">(job)</span> {</span>
                logger.log(<span class="string">'startWorker:'</span>, <span class="string">'pid:'</span>, process.pid, <span class="string">'job:'</span>, util.inspect(job, <span class="literal">null</span>, <span class="literal">null</span>));
                self.runJob(job);
            });</pre></div>
        
      
        
        <p>Maintenance tasks</p>

        
          <div class='highlight'><pre>            setInterval(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></pre></div>
        
      
        
        <p>Check idle time, exit worker if no jobs submitted</p>

        
          <div class='highlight'><pre>                <span class="keyword">if</span> (self.idleTime &gt; <span class="number">0</span> &amp;&amp; !self.jobs.length &amp;&amp; core.now() - self.jobTime &gt; self.idleTime) {
                    logger.log(<span class="string">'startWorker:'</span>, <span class="string">'idle:'</span>, self.idleTime);
                    process.exit(<span class="number">0</span>);
                }
            }, <span class="number">30000</span>);

            process.send(<span class="string">'ready'</span>);

            logger.log(<span class="string">'startWorker:'</span>, <span class="string">'id:'</span>, cluster.worker.id, <span class="string">'version:'</span>, core.version, <span class="string">'home:'</span>, core.home, <span class="string">'uid:'</span>, process.getuid(), <span class="string">'gid:'</span>, process.getgid(), <span class="string">'pid:'</span>, process.pid);
        }
        core.dropPrivileges();
    },</pre></div>
        
      
        
        <p>Create Express server, setup worker environment, call supplied callback to set initial environment</p>

        
          <div class='highlight'><pre>    startWeb: <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;

        <span class="keyword">if</span> (cluster.isMaster) {
            core.role = <span class="string">'server'</span>;
            process.title = core.name + <span class="string">': server'</span>;</pre></div>
        
      
        
        <p>Setup IPC communication</p>

        
          <div class='highlight'><pre>            core.ipcInitServer();</pre></div>
        
      
        
        <p>REPL command prompt over TCP</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span> (core.argv.indexOf(<span class="string">"-repl"</span>) &gt; <span class="number">0</span>) self.startRepl(core.replPort, core.replBind);</pre></div>
        
      
        
        <p>Worker process to handle all web requests</p>

        
          <div class='highlight'><pre>            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.maxProcesses; i++) {
                cluster.fork();
            }</pre></div>
        
      
        
        <p>Frontend server tasks</p>

        
          <div class='highlight'><pre>            setInterval(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></pre></div>
        
      
        
        <p>Make sure we have all workers running</p>

        
          <div class='highlight'><pre>                <span class="keyword">var</span> workers = Object.keys(cluster.workers);
                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.maxProcesses - workers.length; i++) {
                    cluster.fork();
                }
            }, <span class="number">5000</span>);</pre></div>
        
      
        
        <p>Restart if any worker dies, keep the worker pool alive</p>

        
          <div class='highlight'><pre>            cluster.on(<span class="string">"exit"</span>, <span class="function"><span class="keyword">function</span><span class="params">(worker, code, signal)</span> {</span>
                logger.log(<span class="string">'web worker: died:'</span>, worker.id, <span class="string">'pid:'</span>, worker.process.pid || <span class="string">""</span>, <span class="string">"code:"</span>, code || <span class="string">""</span>, <span class="string">'signal:'</span>, signal || <span class="string">""</span>);
                self.respawn(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> cluster.fork(); });
            });
            logger.log(<span class="string">'startWeb:'</span>, <span class="string">'master'</span>, <span class="string">'version:'</span>, core.version, <span class="string">'home:'</span>, core.home, <span class="string">'port:'</span>, core.port, <span class="string">'uid:'</span>, process.getuid(), <span class="string">'gid:'</span>, process.getgid(), <span class="string">'pid:'</span>, process.pid)

        } <span class="keyword">else</span> {
            core.role = <span class="string">'web'</span>;
            process.title = core.name + <span class="string">": web"</span></pre></div>
        
      
        
        <p>Setup IPC communication</p>

        
          <div class='highlight'><pre>            core.ipcInitClient();</pre></div>
        
      
        
        <p>Init API environment</p>

        
          <div class='highlight'><pre>            core.context.api.init(<span class="function"><span class="keyword">function</span><span class="params">(err)</span> {</span>
                core.dropPrivileges();
            });
            
            logger.log(<span class="string">'startWeb:'</span>, core.role, <span class="string">'version:'</span>, core.version, <span class="string">'home:'</span>, core.home, <span class="string">'port:'</span>, core.port, core.bind, <span class="string">'uid:'</span>, process.getuid(), <span class="string">'gid:'</span>, process.getgid(), <span class="string">'pid:'</span>, process.pid)
        }
    },</pre></div>
        
      
        
        <p>Spawn web server from the master as a separate master with web workers, it is used when web and master processes are running on the same server</p>

        
          <div class='highlight'><pre>    startWebProcess: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> 
        <span class="keyword">if</span> (core.argv.indexOf(<span class="string">"-web"</span>) == -<span class="number">1</span>) <span class="keyword">return</span>;
        <span class="keyword">var</span> params = [];
        <span class="keyword">var</span> val = core.getArg(<span class="string">"-web-port"</span>, core.port);
        <span class="keyword">if</span> (val) params.push(<span class="string">"-port"</span>, val);
        val = core.getArg(<span class="string">"-web-bind"</span>);
        <span class="keyword">if</span> (val) params.push(<span class="string">"-bind"</span>, val);
        val = core.getArg(<span class="string">"-web-repl-port"</span>);
        <span class="keyword">if</span> (val) params.push(<span class="string">"-repl-port"</span>, val);
        val = core.getArg(<span class="string">"-web-repl-bind"</span>);
        <span class="keyword">if</span> (val) params.push(<span class="string">"-repl-bind"</span>, val);
        
        <span class="keyword">var</span> child = <span class="keyword">this</span>.spawnProcess(params, [<span class="string">"-port"</span>, <span class="string">"-bind"</span>, <span class="string">"-repl-port"</span>, <span class="string">"-repl-bind"</span>, <span class="string">"-master"</span> ], { stdio: <span class="string">'inherit'</span> });
        <span class="keyword">this</span>.pids.push(child.pid);
        child.on(<span class="string">'exit'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(code, signal)</span> {</span>
            logger.log(<span class="string">'process terminated:'</span>, <span class="string">'pid:'</span>, <span class="keyword">this</span>.pid, name, <span class="string">'code:'</span>, code, <span class="string">'signal:'</span>, signal);</pre></div>
        
      
        
        <p>Make sure all web servers are down before restating to avoid EADDRINUSE error condition</p>

        
          <div class='highlight'><pre>            core.killBackend(<span class="string">"web"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                self.respawn(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> self.startWebProcess(); });
            });
        });
        child.unref();
    },</pre></div>
        
      
        
        <p>Spawn web proxy from the master as a separate master with web workers</p>

        
          <div class='highlight'><pre>    startWebProxy: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> 
        <span class="keyword">if</span> (core.argv.indexOf(<span class="string">"-proxy"</span>) == -<span class="number">1</span>) <span class="keyword">return</span>;
        <span class="keyword">var</span> params = [ <span class="string">"-db-no-pools"</span> ];
        <span class="keyword">var</span> val = core.getArg(<span class="string">"-proxy-port"</span>, core.port);
        <span class="keyword">if</span> (val) params.push(<span class="string">"-port"</span>, val);
        val = core.getArg(<span class="string">"-proxy-bind"</span>);
        <span class="keyword">if</span> (val) params.push(<span class="string">"-bind"</span>, val);
        
        <span class="keyword">var</span> child = <span class="keyword">this</span>.spawnProcess(params, [<span class="string">"-port"</span>, <span class="string">"-bind"</span>, <span class="string">"-master"</span> ], { stdio: <span class="string">'inherit'</span> });
        <span class="keyword">this</span>.pids.push(child.pid);
        child.on(<span class="string">'exit'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(code, signal)</span> {</span>
            logger.log(<span class="string">'process terminated:'</span>, <span class="string">'pid:'</span>, <span class="keyword">this</span>.pid, name, <span class="string">'code:'</span>, code, <span class="string">'signal:'</span>, signal);</pre></div>
        
      
        
        <p>Make sure all web servers are down before restating to avoid EADDRINUSE error condition</p>

        
          <div class='highlight'><pre>            core.killBackend(<span class="string">"proxy"</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                self.respawn(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> self.startWebProxy(); });
            });
        });
        child.unref();
    },</pre></div>
        
      
        
        <p>Start http proxy as standalone server process</p>

        
          <div class='highlight'><pre>    startProxy: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">var</span> config = <span class="literal">null</span>;
        
        core.role = <span class="string">'proxy'</span>;
        process.title = core.name + <span class="string">": proxy"</span>
        
        <span class="keyword">try</span> { config = JSON.parse(fs.readFileSync(path.join(core.path.etc, <span class="string">"proxy"</span>)).toString()); } <span class="keyword">catch</span> (e) { logger.error(<span class="string">'startProxy:'</span>, e); }
        <span class="keyword">if</span> (!config) <span class="keyword">return</span> logger.error(<span class="string">'startProxy:'</span>, <span class="string">'no config file'</span>);

        <span class="keyword">if</span> (config.https) {
            Object.keys(config.https).forEach(<span class="function"><span class="keyword">function</span> <span class="params">(key)</span> {</span>
                <span class="keyword">try</span> { config.https[key] = fs.readFileSync(path.join(core.path.etc, config.https[key])); } <span class="keyword">catch</span>(e) { logger.error(<span class="string">'startProxy:'</span>, e) }
            });
        }
        <span class="keyword">try</span> { self.proxy = proxy.createServer(config).listen(core.port, core.bind); } <span class="keyword">catch</span>(e) { logger.error(<span class="string">'startProxy:'</span>, e) }
    },</pre></div>
        
      
        
        <p>Restart process with the same arguments and setup as a monitor for the spawn child</p>

        
          <div class='highlight'><pre>    startProcess: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">this</span>.child = <span class="keyword">this</span>.spawnProcess();</pre></div>
        
      
        
        <p>Pass child output to the console</p>

        
          <div class='highlight'><pre>        <span class="keyword">this</span>.child.stdout.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span>
            util.print(data);
        })
        <span class="keyword">this</span>.child.stderr.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span><span class="params">(error)</span> {</span>
            util.print(error);
        })</pre></div>
        
      
        
        <p>Restart if dies or exits</p>

        
          <div class='highlight'><pre>        <span class="keyword">this</span>.child.on(<span class="string">'exit'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(code, signal)</span> {</span>
            logger.log(<span class="string">'process terminated:'</span>, <span class="string">'code:'</span>, code, <span class="string">'signal:'</span>, signal);
            core.killBackend(<span class="string">""</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                self.respawn(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                    self.startProcess();
                });
            });
        });
        process.stdin.pipe(<span class="keyword">this</span>.child.stdin);
        logger.log(<span class="string">'startProcess:'</span>, <span class="string">'version:'</span>, core.version, <span class="string">'home:'</span>, core.home, <span class="string">'port:'</span>, core.port, <span class="string">'uid:'</span>, process.getuid(), <span class="string">'gid:'</span>, process.getgid(), <span class="string">'pid:'</span>, process.pid)
    },</pre></div>
        
      
        
        <p>Watch source files for modifications and restart</p>

        
          <div class='highlight'><pre>    startWatcher: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        logger.debug(<span class="string">'startWatcher:'</span>, core.watchdirs);
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
   
        <span class="keyword">if</span> (core.watchdirs.indexOf(__dirname) == -<span class="number">1</span>) core.watchdirs.push(__dirname);
        core.watchdirs.forEach(<span class="function"><span class="keyword">function</span><span class="params">(dir)</span> {</span>
            core.watchFiles(dir, <span class="regexp">/\.js$/</span>, <span class="function"><span class="keyword">function</span><span class="params">(file)</span> {</span>
                <span class="keyword">if</span> (self.watchTimer) clearTimeout(self.watchTimer);
                self.watchTimer = setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> 
                    logger.log(<span class="string">'watcher:'</span>, <span class="string">'restarting'</span>, self.child.pid);
                    <span class="keyword">if</span> (self.child) self.child.kill(); <span class="keyword">else</span> self.startProcess();
                }, self.restartDelay);
            });
        });
        <span class="keyword">this</span>.startProcess();
    },</pre></div>
        
      
        
        <p>Start command prompt on TCP socket, context can be an object with properties assigned with additional object to be accessible in the shell</p>

        
          <div class='highlight'><pre>    startRepl: <span class="function"><span class="keyword">function</span><span class="params">(port, bind)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">var</span> repl = net.createServer(<span class="function"><span class="keyword">function</span><span class="params">(socket)</span> {</span>
            self.repl = core.createRepl({ prompt: <span class="string">'&gt; '</span>, input: socket, output: socket, terminal: <span class="literal">true</span>, useGlobal: <span class="literal">false</span> });
            self.repl.on(<span class="string">'exit'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> socket.end(); })
            self.repl.context.socket = socket;
        });
        repl.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span><span class="params">(err)</span> {</span>
           logger.error(<span class="string">'startRepl:'</span>, err);
        });
        repl.listen(port, bind || <span class="string">'0.0.0.0'</span>);
        logger.debug(<span class="string">'startRepl:'</span>, <span class="string">'port:'</span>, port, <span class="string">'bind:'</span>, bind || <span class="string">'0.0.0.0'</span>);
    },</pre></div>
        
      
        
        <p>Create daemon from the current process, restart node with -daemon removed in the background</p>

        
          <div class='highlight'><pre>    startDaemon: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></pre></div>
        
      
        
        <p>Avoid spawning loop, skip daemon flag</p>

        
          <div class='highlight'><pre>        <span class="keyword">var</span> argv = process.argv.slice(<span class="number">1</span>).filter(<span class="function"><span class="keyword">function</span><span class="params">(x)</span> {</span> <span class="keyword">return</span> x != <span class="string">"-daemon"</span>; });

        <span class="keyword">this</span>.errlog = <span class="keyword">new</span> stream.Stream();
        <span class="keyword">this</span>.errlog.writable = <span class="literal">true</span>;
        <span class="keyword">this</span>.errlog.write = <span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span> logger.error(data); <span class="keyword">return</span> <span class="literal">true</span>; }

        spawn(process.argv[<span class="number">0</span>], argv, { stdio: [ <span class="string">'ignore'</span>, errlog, errlog ], detached: <span class="literal">true</span> });
        process.exit(<span class="number">0</span>);
    },</pre></div>
        
      
        
        <p>Sleep and keep a worker busy</p>

        
          <div class='highlight'><pre>    sleep: <span class="function"><span class="keyword">function</span><span class="params">(options, callback)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = <span class="literal">null</span>;
        <span class="keyword">if</span> (!options) options = {};
        setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            logger.log(<span class="string">'sleep:'</span>, options);
            <span class="keyword">if</span> (callback) callback();
        }, options.timeout || <span class="number">30000</span>);
    },</pre></div>
        
      
        
        <p>Shutdown the system immediately, mostly to be used in the remote jobs as the last task</p>

        
          <div class='highlight'><pre>    shutdown: <span class="function"><span class="keyword">function</span><span class="params">(options, callback)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = <span class="literal">null</span>;
        <span class="keyword">if</span> (!options) options = {};
        
        logger.log(<span class="string">'shutdown:'</span>, <span class="string">'server'</span>);
        core.watchLogs(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> core.shutdown(); }, options.timeout || <span class="number">30000</span>);
        });
    },</pre></div>
        
      
        
        <p>If respawning too fast, delay otherwise schedule new process after short timeout</p>

        
          <div class='highlight'><pre>    respawn: <span class="function"><span class="keyword">function</span><span class="params">(callback)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">this</span>.exiting) <span class="keyword">return</span>;
        <span class="keyword">var</span> now = <span class="keyword">new</span> Date();
        <span class="keyword">if</span> (<span class="keyword">this</span>.crashTime &amp;&amp; now.getTime() - <span class="keyword">this</span>.crashTime.getTime() &lt; <span class="keyword">this</span>.crashInterval*(<span class="keyword">this</span>.crashCount+<span class="number">1</span>)) {
            <span class="keyword">if</span> (<span class="keyword">this</span>.crashCount &amp;&amp; <span class="keyword">this</span>.crashEvents &gt;= <span class="keyword">this</span>.crashCount) {
                logger.log(<span class="string">'respawn:'</span>, <span class="string">'throttling for'</span>, <span class="keyword">this</span>.crashDelay, <span class="string">'after'</span>, <span class="keyword">this</span>.crashEvents, <span class="string">'crashes in '</span>, now.getTime() - <span class="keyword">this</span>.crashTime.getTime(), <span class="string">'ms'</span>);
                <span class="keyword">this</span>.crashEvents = <span class="number">0</span>;
                <span class="keyword">this</span>.crashTime = now;
                <span class="keyword">return</span> setTimeout(callback, <span class="keyword">this</span>.crashDelay);
            }
            <span class="keyword">this</span>.crashEvents++;
        } <span class="keyword">else</span> {
            <span class="keyword">this</span>.crashEvents = <span class="number">0</span>;
        }
        <span class="keyword">this</span>.crashTime = now;
        setTimeout(callback, <span class="keyword">this</span>.crashInterval);
    },</pre></div>
        
      
        
        <p>Start new process reusing global process arguments, args will be added and args in the skip list will be removed</p>

        
          <div class='highlight'><pre>    spawnProcess: <span class="function"><span class="keyword">function</span><span class="params">(args, skip, opts)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">this</span>.exiting) <span class="keyword">return</span>;</pre></div>
        
      
        
        <p>Arguments to skip when launchng new process</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> (!skip) skip = [];
        skip.push(<span class="string">"-daemon"</span>);
        skip.push(<span class="string">"-watch"</span>);
        skip.push(<span class="string">"-monitor"</span>);</pre></div>
        
      
        
        <p>Remove arguments we should not pass to the process</p>

        
          <div class='highlight'><pre>        <span class="keyword">var</span> argv = process.argv.slice(<span class="number">1</span>).filter(<span class="function"><span class="keyword">function</span><span class="params">(x)</span> {</span> <span class="keyword">return</span> skip.indexOf(x) == -<span class="number">1</span>; });
        <span class="keyword">if</span> (Array.isArray(args)) argv = argv.concat(args);
        logger.debug(<span class="string">'spawnProcess:'</span>, argv, skip);
        <span class="keyword">return</span> spawn(process.argv[<span class="number">0</span>], argv, opts);
    },</pre></div>
        
      
        
        <p>Run all jobs from the job spec at the same time, when the last job finishes and it is running in the worker process, the process
terminates.</p>

        
          <div class='highlight'><pre>    runJob: <span class="function"><span class="keyword">function</span><span class="params">(job)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;

        <span class="keyword">for</span> (<span class="keyword">var</span> name <span class="keyword">in</span> job) {
            <span class="keyword">var</span> args = [];</pre></div>
        
      
        
        <p>Pass as first argument the options object, then callback</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span> (core.typeName(job[name]) == <span class="string">"object"</span> &amp;&amp; Object.keys(job[name]).length) args.push(job[name]);</pre></div>
        
      
        
        <p>The callback to finalize job execution</p>

        
          <div class='highlight'><pre>            (<span class="function"><span class="keyword">function</span> <span class="params">(jname)</span> {</span>
                args.push(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                    self.jobTime = core.now();</pre></div>
        
      
        
        <p>Update process title with current job list</p>

        
          <div class='highlight'><pre>                    <span class="keyword">var</span> idx = self.jobs.indexOf(jname);
                    <span class="keyword">if</span> (idx &gt; -<span class="number">1</span>) self.jobs.splice(idx, <span class="number">1</span>);
                    <span class="keyword">if</span> (cluster.isWorker) process.title = core.name + <span class="string">': worker '</span> + self.jobs.join(<span class="string">','</span>);

                    logger.log(<span class="string">'runJob:'</span>, <span class="string">'finished'</span>, jname);
                    <span class="keyword">if</span> (!self.jobs.length &amp;&amp; cluster.isWorker) process.exit(<span class="number">0</span>);
                });
            })(name);</pre></div>
        
      
        
        <p>Make report about unknown job, leading $ are used for same method miltiple times in the same job because 
method names are unique in the object</p>

        
          <div class='highlight'><pre>            <span class="keyword">var</span> spec = name.replace(<span class="regexp">/^[\$]+/g</span>, <span class="string">""</span>).split(<span class="string">'.'</span>);
            <span class="keyword">var</span> obj = core.context[spec[<span class="number">0</span>]];
            <span class="keyword">if</span> (!obj || !obj[spec[<span class="number">1</span>]]) {
                logger.error(<span class="string">'runJob:'</span>, name, <span class="string">"unknown method in"</span>, job);
                <span class="keyword">if</span> (core.role == <span class="string">"worker"</span>) process.exit(<span class="number">1</span>);
                <span class="keyword">continue</span>;
            }
            self.jobTime = core.now();
            self.jobs.push(name);
            <span class="keyword">if</span> (cluster.isWorker) process.title = core.name + <span class="string">': worker '</span> + self.jobs.join(<span class="string">','</span>);
            logger.log(<span class="string">'runJob:'</span>, <span class="string">'started'</span>, name, job[name] || <span class="string">""</span>);
            obj[spec[<span class="number">1</span>]].apply(obj, args);
        }
    },</pre></div>
        
      
        
        <p>Execute job in the background by one of the workers, object must be known exported module
and method must be existing method of the given object. The method function must take options 
object as its first argument and callback as its second argument.
More than one job can be specified, property of the object defines name for the job to run: 
Example: { &#39;scraper.run&#39;: {}, &#39;server.shutdown&#39;: {} }
If the same object.method must be executed several times, prepend subsequent jobs with $
Example: { &#39;scraper.run&#39;: { &quot;arg&quot;: 1 }, &#39;$scraper.run&#39;: { &quot;arg&quot;: 2 }, &#39;$$scraper.run&#39;: { &quot;arg&quot;: 3 } }
Supported options by the server:</p>
<ul>
<li>runalways - no checks for existing job wth the same name should be done</li>
<li>runlast - run when no more pending or running jobs</li>
<li>runafter - specifies another job in canoncal form obj.method which must finish and not be pending in<pre><code>       order for this job to start, this implements chaining of jobs to be executed one after another
       but submitted at the same time
       Exampe: submit 3 jobs to run sequentially:
         &#39;amazon.import&#39;
         { &#39;imdb.sync&#39;: { runafter: &#39;amazon.import&#39; } }
         { &#39;server.shutdown&#39;: { runafter: &#39;imdb.sync&#39; } }</code></pre>
</li>
</ul>

        
          <div class='highlight'><pre>    execJob: <span class="function"><span class="keyword">function</span><span class="params">(job)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;

        <span class="keyword">if</span> (cluster.isWorker) <span class="keyword">return</span> logger.error(<span class="string">'exec: can be called from the master only'</span>, job);</pre></div>
        
      
        
        <p>Build job object with canonical name</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> (<span class="keyword">typeof</span> job == <span class="string">"string"</span>) job = core.newObj(job, <span class="literal">null</span>);
        <span class="keyword">if</span> (<span class="keyword">typeof</span> job != <span class="string">"object"</span>) <span class="keyword">return</span> logger.error(<span class="string">'exec:'</span>, <span class="string">'invalid job'</span>, job);</pre></div>
        
      
        
        <p>Do not exceed max number of running workers</p>

        
          <div class='highlight'><pre>        <span class="keyword">var</span> workers = Object.keys(cluster.workers);
        <span class="keyword">if</span> (workers.length &gt;= self.maxWorkers) {
            self.queue.push(job);
            <span class="keyword">return</span> logger.debug(<span class="string">'execJob:'</span>, <span class="string">'max number of workers running:'</span>, self.maxWorkers, <span class="string">'job:'</span>, job);
        }</pre></div>
        
      
        
        <p>Perform conditions check, any failed condition will reject the whole job</p>

        
          <div class='highlight'><pre>        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> job) {
            <span class="keyword">var</span> opts = job[p] || {};</pre></div>
        
      
        
        <p>Do not execute if we already have this job running</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span> (self.jobs.indexOf(p) &gt; -<span class="number">1</span> &amp;&amp; !opts.runalways) {
                <span class="keyword">if</span> (!opts.skipqueue) self.queue.push(job);
                <span class="keyword">return</span> logger.debug(<span class="string">'execJob: already running'</span>, job);
            }</pre></div>
        
      
        
        <p>Condition for job, should not be any pending or running jobs</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span> (opts.runlast) {
                <span class="keyword">if</span> (self.jobs.length || self.queue.length) {
                    <span class="keyword">if</span> (!opts.skipqueue) self.queue.push(job);
                    <span class="keyword">return</span> logger.debug(<span class="string">'execJob:'</span>, <span class="string">'other jobs still exist'</span>, job);
                }
            }</pre></div>
        
      
        
        <p>Check dependencies, only run when there is no dependent job in the running list</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span> (opts.runone) {
                <span class="keyword">if</span> (self.jobs.filter(<span class="function"><span class="keyword">function</span><span class="params">(x)</span> {</span> <span class="keyword">return</span> x.match(opts.runone) }).length) {
                    <span class="keyword">if</span> (!opts.skipqueue) self.queue.push(job);
                    <span class="keyword">return</span> logger.debug(<span class="string">'execJob:'</span>, <span class="string">'depending job still exists:'</span>, job);
                }
            }</pre></div>
        
      
        
        <p>Check dependencies, only run when there is no dependent job in the running or pending lists</p>

        
          <div class='highlight'><pre>            <span class="keyword">if</span> (opts.runafter) {
                <span class="keyword">if</span> (self.jobs.some(<span class="function"><span class="keyword">function</span><span class="params">(x)</span> {</span> <span class="keyword">return</span> x.match(opts.runafter) }) ||
                    self.queue.some(<span class="function"><span class="keyword">function</span><span class="params">(x)</span> {</span> <span class="keyword">return</span> Object.keys(x).some(<span class="function"><span class="keyword">function</span><span class="params">(y)</span> {</span> <span class="keyword">return</span> y.match(opts.runafter); }); })) {
                    <span class="keyword">if</span> (!opts.skipqueue) self.queue.push(job);
                    <span class="keyword">return</span> logger.debug(<span class="string">'execJob:'</span>, <span class="string">'depending job still exists:'</span>, job);
                }
            }
        }

        self.jobTime = core.now();
        logger.log(<span class="string">'execJob:'</span>, <span class="string">'workers:'</span>, workers.length, <span class="string">'job:'</span>, util.inspect(job, <span class="literal">null</span>, <span class="literal">null</span>))</pre></div>
        
      
        
        <p>Start a worker, send the job and wait when it finished</p>

        
          <div class='highlight'><pre>        <span class="keyword">var</span> worker = cluster.fork();
        worker.on(<span class="string">"error"</span>, <span class="function"><span class="keyword">function</span><span class="params">(e)</span> {</span>
            logger.error(<span class="string">'execJob:'</span>, e, job);
            worker = <span class="literal">null</span>;
        })
        worker.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span><span class="params">(msg)</span> {</span>
            <span class="keyword">if</span> (msg != <span class="string">"ready"</span>) <span class="keyword">return</span>;
            worker.send(job);</pre></div>
        
      
        
        <p>Make sure we add new jobs after we successfully created a new worker</p>

        
          <div class='highlight'><pre>            self.jobs = self.jobs.concat(Object.keys(job));
        });
        worker.on(<span class="string">"exit"</span>, <span class="function"><span class="keyword">function</span><span class="params">(code, signal)</span> {</span>
            logger.log(<span class="string">'execJob: finished:'</span>, worker.id, <span class="string">'pid:'</span>, worker.process.pid, <span class="string">'code:'</span>, code || <span class="number">0</span>, <span class="string">'/'</span>, signal || <span class="number">0</span>, <span class="string">'job:'</span>, util.inspect(job, <span class="literal">null</span>, <span class="literal">null</span>));
            <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> job) {
                <span class="keyword">var</span> idx = self.jobs.indexOf(p);
                <span class="keyword">if</span> (idx &gt; -<span class="number">1</span>) self.jobs.splice(idx, <span class="number">1</span>);
            }
            worker = <span class="literal">null</span>;
        });
        <span class="keyword">return</span> <span class="literal">true</span>;
    },</pre></div>
        
      
        
        <p>Remote mode, launch remote instance to perform scraping or other tasks
By default, shutdown the instance after job finishes unless noshutdown:1 is specified in the options</p>

        
          <div class='highlight'><pre>    launchJob: <span class="function"><span class="keyword">function</span><span class="params">(job, options, callback)</span> {</span>
        <span class="keyword">if</span> (!job) <span class="keyword">return</span>;
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = <span class="literal">null</span>;
        <span class="keyword">if</span> (!options) options = {};
        
        <span class="keyword">if</span> (<span class="keyword">typeof</span> job == <span class="string">"string"</span>) job = core.newObj(job, <span class="literal">null</span>);
        <span class="keyword">if</span> (!Object.keys(job).length) <span class="keyword">return</span> logger.error(<span class="string">'launchJob:'</span>, <span class="string">'no valid jobs:'</span>, job);
        job = core.cloneObj(job);</pre></div>
        
      
        
        <p>Default btime flag for all jobs</p>

        
          <div class='highlight'><pre>        <span class="keyword">var</span> btime = core.sqlTime();
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> job) {
            <span class="keyword">if</span> (!job[p]) job[p] = {};
            <span class="keyword">if</span> (<span class="keyword">typeof</span> job[p].btime == <span class="string">"undefined"</span>) job[p].btime = btime;
        }

        <span class="keyword">this</span>.jobTime = core.now();
        logger.log(<span class="string">'launchJob:'</span>, util.inspect(job, <span class="literal">true</span>, <span class="literal">null</span>), options);</pre></div>
        
      
        
        <p>Common arguments for remote workers</p>

        
          <div class='highlight'><pre>        <span class="keyword">var</span> args = [<span class="string">"-master"</span>, <span class="string">"-instance"</span>,
                    <span class="string">"-backend-host"</span>, core.backendHost || <span class="string">""</span>,
                    <span class="string">"-backend-key"</span>, core.backendKey || <span class="string">""</span>,
                    <span class="string">"-backend-secret"</span>, core.backendSecret || <span class="string">""</span>,
                    <span class="string">"-jobname"</span>, Object.keys(job).join(<span class="string">","</span>),
                    <span class="string">"-job"</span>, <span class="keyword">new</span> Buffer(JSON.stringify(job)).toString(<span class="string">"base64"</span>) ];
        
        <span class="keyword">if</span> (!options.noshutdown) {
            args.push(<span class="string">"-job"</span>, <span class="keyword">new</span> Buffer(JSON.stringify({ <span class="string">'server.shutdown'</span>: { runlast: <span class="number">1</span> } })).toString(<span class="string">"base64"</span>));
        }</pre></div>
        
      
        
        <p>Command line arguments for the instance, must begin with -</p>

        
          <div class='highlight'><pre>        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> options) {
            <span class="keyword">if</span> (p[<span class="number">0</span>] != <span class="string">'-'</span>) <span class="keyword">continue</span>;
            args.push(p, options[p])
        }
        aws.runInstances(<span class="number">1</span>, args.map(<span class="function"><span class="keyword">function</span><span class="params">(x)</span> {</span> <span class="keyword">return</span> String(x).replace(<span class="regexp">/ /g</span>, <span class="string">'%20'</span>) }).join(<span class="string">" "</span>), callback);
        <span class="keyword">return</span> <span class="literal">true</span>;
    },</pre></div>
        
      
        
        <p>Run a job, the string is in the format:
object/method/name/value/name/value....
All spaces must be are replaced with %20 to be used in command line parameterrs</p>

        
          <div class='highlight'><pre>    queueJob: <span class="function"><span class="keyword">function</span><span class="params">(job)</span> {</span>
        <span class="keyword">if</span> (!job) <span class="keyword">return</span>;
        <span class="keyword">switch</span> (core.typeName(job)) {
        <span class="keyword">case</span> <span class="string">"object"</span>:
            <span class="keyword">this</span>.queue.push(job);
            <span class="keyword">break</span>;

        <span class="keyword">case</span> <span class="string">"string"</span>:
            <span class="keyword">try</span> {
                <span class="keyword">this</span>.queue.push(JSON.parse(<span class="keyword">new</span> Buffer(job, <span class="string">"base64"</span>).toString()));
            } <span class="keyword">catch</span>(e) {
                logger.error(<span class="string">'queueJob:'</span>, e, job);
            }
            <span class="keyword">break</span>;
        }
    },</pre></div>
        
      
        
        <p>Process pending jobs, submit to idle workers</p>

        
          <div class='highlight'><pre>    execQueue: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (!<span class="keyword">this</span>.queue.length) <span class="keyword">return</span>;
        <span class="keyword">var</span> job = <span class="keyword">this</span>.queue.shift();
        <span class="keyword">if</span> (!job) <span class="keyword">return</span>;
        <span class="keyword">this</span>.execJob(job);
    },</pre></div>
        
      
        
        <p>Create new cron job
Example: { &quot;type&quot;: &quot;server&quot;, &quot;cron&quot;: &quot;0 <em>/10 </em> <em> </em> <em>&quot;, &quot;job&quot;: &quot;server.processJobs&quot; },
         { &quot;type&quot;: &quot;local&quot;, &quot;cron&quot;: &quot;0 10 7 </em> <em> </em>&quot;, &quot;job&quot;: &quot;api.processQueue&quot; } </p>

        
          <div class='highlight'><pre>    scheduleCronjob: <span class="function"><span class="keyword">function</span><span class="params">(spec, obj)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">var</span> job = self.checkJob(<span class="string">'local'</span>, obj.job);
        <span class="keyword">if</span> (!job) <span class="keyword">return</span>;
        logger.debug(<span class="string">'scheduleCronjob:'</span>, spec, util.inspect(obj, <span class="literal">true</span>, <span class="literal">null</span>));
        <span class="keyword">var</span> cj = <span class="keyword">new</span> cron.CronJob(spec, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">if</span> (<span class="keyword">this</span>.host) {
                self.submitJob({ type: <span class="keyword">this</span>.type, host: <span class="keyword">this</span>.host, job: job }); 
            } <span class="keyword">else</span> {
                self.doJob(<span class="keyword">this</span>.type, job);
            }
        }, <span class="literal">null</span>, <span class="literal">true</span>);
        cj.type = obj.type;
        cj.host = obj.host;
        cj.id = obj.id;
        <span class="keyword">this</span>.crontab.push(cj);
    },</pre></div>
        
      
        
        <p>Create new cron job to be run on a drone in the cloud
For remote jobs additonal property args can be used in the cron object to define 
arguments to the instance backend process, properties must start with -
Example: { &quot;type&quot;: &quot;remote&quot;, &quot;cron&quot;: &quot;0 5 <em> </em> <em> </em>&quot;, &quot;args&quot;: { &quot;-workers&quot;: 2 }, &quot;job&quot;: { &quot;scraper.run&quot;: { &quot;url&quot;: &quot;host1&quot; }, &quot;$scraper.run&quot;: { &quot;url&quot;: &quot;host2&quot; } } }</p>

        
          <div class='highlight'><pre>    scheduleLaunchjob: <span class="function"><span class="keyword">function</span><span class="params">(spec, obj)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">var</span> job = self.checkJob(<span class="string">'remote'</span>, obj.job);
        <span class="keyword">if</span> (!job) <span class="keyword">return</span>;
        logger.debug(<span class="string">'scheduleLaunchjob:'</span>, spec, util.inspect(obj, <span class="literal">true</span>, <span class="literal">null</span>));
        <span class="keyword">var</span> cj = <span class="keyword">new</span> cron.CronJob(spec, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> self.doJob(<span class="keyword">this</span>.type, job, obj.args)  }, <span class="literal">null</span>, <span class="literal">true</span>);
        cj.type = obj.type;
        cj.id = obj.id;
        <span class="keyword">this</span>.crontab.push(cj);
    },</pre></div>
        
      
        
        <p>Execute a cronjob by name now</p>

        
          <div class='highlight'><pre>    runCronjob: <span class="function"><span class="keyword">function</span><span class="params">(id)</span> {</span>
        <span class="keyword">this</span>.crontab.forEach(<span class="function"><span class="keyword">function</span><span class="params">(x)</span> {</span>
           <span class="keyword">if</span> (x.id == id) x._callback();
        });
    },</pre></div>
        
      
        
        <p>Perform execution according to type</p>

        
          <div class='highlight'><pre>    doJob: <span class="function"><span class="keyword">function</span><span class="params">(type, job, options)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">switch</span> (type) {
        <span class="keyword">case</span> <span class="string">'remote'</span>:
            setImmediate(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> self.launchJob(job, options); });
            <span class="keyword">break</span>;

        <span class="keyword">case</span> <span class="string">"server"</span>:
            setImmediate(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> self.runJob(job); });
            <span class="keyword">break</span>;
            
        <span class="keyword">default</span>:
            setImmediate(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> self.queueJob(job); });
            <span class="keyword">break</span>;
        }
    },</pre></div>
        
      
        
        <p>Verify job structure and permissions and return as an object if the job is a string
Permissions are checked against jobsAllow/jobsDisallow configuration parameters, see allowJob method</p>

        
          <div class='highlight'><pre>    checkJob: <span class="function"><span class="keyword">function</span><span class="params">(type, job)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> job == <span class="string">"string"</span>) job = core.newObj(job, <span class="literal">null</span>);
        <span class="keyword">if</span> (<span class="keyword">typeof</span> job != <span class="string">"object"</span>) <span class="keyword">return</span> <span class="literal">null</span>;
        job = core.cloneObj(job);
        <span class="keyword">for</span> (<span class="keyword">var</span> p <span class="keyword">in</span> job) <span class="keyword">if</span> (!<span class="keyword">this</span>.allowJob(type, p)) <span class="keyword">delete</span> job[p];
        <span class="keyword">if</span> (!Object.keys(job).length) <span class="keyword">return</span> <span class="literal">null</span>;
        <span class="keyword">return</span> job;
    },</pre></div>
        
      
        
        <p>Return true if given job can be run on this server, type is local or remote and will be prepended to the job spec so
the regexp can use the full spec or parts of it like : local.imdb.sync or remote.imdb.sync</p>

        
          <div class='highlight'><pre>    allowJob: <span class="function"><span class="keyword">function</span><span class="params">(type, name)</span> {</span>
        <span class="keyword">var</span> job = type + <span class="string">'.'</span> + name;
        <span class="keyword">if</span> ((<span class="keyword">this</span>.jobsDisallow &amp;&amp; <span class="keyword">this</span>.jobsDisallow.test(job)) || (<span class="keyword">this</span>.jobsAllow &amp;&amp; !<span class="keyword">this</span>.jobsAllow.test(job))) {
            logger.debug(<span class="string">"allowJob:"</span>, <span class="string">"no"</span>, type, name, <span class="string">"rx:"</span>, <span class="keyword">this</span>.jobsDisallow, <span class="keyword">this</span>.jobsAllow);
            <span class="keyword">return</span> <span class="literal">false</span>;
        }
        logger.debug(<span class="string">"allowJob:"</span>, <span class="string">"yes"</span>, type, name);
        <span class="keyword">return</span> <span class="literal">true</span>;
    },</pre></div>
        
      
        
        <p>Load crontab from JSON file as list of job specs:</p>
<ul>
<li>type - local, remote, server<pre><code>   local means spawn a worker to run the job function
   remote means launch an AWS instance
   server means run inside the master process, do not spawn a worker</code></pre>
</li>
<li>cron - cron time interval spec: &#39;second&#39; &#39;minute&#39; &#39;hour&#39; &#39;dayOfMonth&#39; &#39;month&#39; &#39;dayOfWeek&#39;</li>
<li>job - a string as obj.method or an object with job name as property name and the value is an object with <pre><code>  additional options for the job passed as first argument, a job callback always takes options and callback as 2 arguments</code></pre>
</li>
<li>args - additional arguments passwed to the backend in the command line for the remote jobs
Example: [ { &quot;type&quot;: &quot;local&quot;, cron: &quot;0 0 <em> </em> <em> </em>&quot;, job: &quot;scraper.run&quot; }, ..]</li>
</ul>

        
          <div class='highlight'><pre>    loadSchedules: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;

        fs.readFile(<span class="string">"etc/crontab"</span>, <span class="function"><span class="keyword">function</span><span class="params">(err, data)</span> {</span>
            <span class="keyword">if</span> (err || !data || !data.length) <span class="keyword">return</span>;
            data = data.toString();
            <span class="keyword">try</span> {
                <span class="keyword">var</span> list = JSON.parse(data);
                <span class="keyword">if</span> (Array.isArray(list)) {
                    self.crontab.forEach(<span class="function"><span class="keyword">function</span><span class="params">(x)</span> {</span> x.stop(); <span class="keyword">delete</span> x; });
                    self.crontab = [];
                    list.forEach(<span class="function"><span class="keyword">function</span><span class="params">(x)</span> {</span>
                        <span class="keyword">if</span> (!x.type || !x.cron || !x.job || x.disabled) <span class="keyword">return</span>;
                        <span class="keyword">switch</span> (x.type) {
                        <span class="keyword">case</span> <span class="string">"remote"</span>:
                            self.scheduleLaunchjob(x.cron, x);
                            <span class="keyword">break</span>;

                        <span class="keyword">default</span>:
                            self.scheduleCronjob(x.cron, x);
                            <span class="keyword">break</span>;
                        }
                    });
                }
                logger.log(<span class="string">"loadSchedules:"</span>, self.crontab.length, <span class="string">"schedules"</span>);
            } <span class="keyword">catch</span>(e) {
                logger.log(<span class="string">'loadSchedules:'</span>, e, data);
            }
        });
    },</pre></div>
        
      
        
        <p>Submit job for execution, it will be saved in the server queue and the master will pick it up later</p>

        
          <div class='highlight'><pre>    submitJob: <span class="function"><span class="keyword">function</span><span class="params">(options, callback)</span> {</span>
        <span class="keyword">if</span> (!options || !options.job) <span class="keyword">return</span> logger.error(<span class="string">'submitJob:'</span>, <span class="string">'invalid job spec:'</span>, options);
        <span class="keyword">var</span> job = JSON.stringify(options.job);
        db.add(<span class="string">"backend_jobs"</span>, { job: job, type: options.type, host: options.host, id: core.hash(job), mtime: core.now() }, { pool: core.dbPool, nocolumns: <span class="number">1</span> }, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">if</span> (callback) callback();
        });
    },</pre></div>
        
      
        
        <p>Run submitted jobs, usually called from the crontab file in case of shared database, requires connection to the PG database
To run it from crontab add line(to run every 5 mins): 
   { type: &quot;server&quot;, cron: &quot;0 <em>/5 </em> <em> </em> *&quot;, job: &quot;server.processJobs&quot; } </p>

        
          <div class='highlight'><pre>    processJobs: <span class="function"><span class="keyword">function</span><span class="params">(options, callback)</span> {</span>
        <span class="keyword">var</span> self = <span class="keyword">this</span>;
        <span class="keyword">if</span> (<span class="keyword">typeof</span> options == <span class="string">"function"</span>) callback = options, options = {};
        <span class="keyword">var</span> hosts = [os.hostname(), os.hostname().split(<span class="string">'.'</span>)[<span class="number">0</span>]];</pre></div>
        
      
        
        <p>Primary job servers, run all jobs with empty host</p>

        
          <div class='highlight'><pre>        <span class="keyword">if</span> (<span class="keyword">this</span>.jobsPrimary) hosts.push(<span class="string">""</span>);
        db.select(<span class="string">"backend_jobs"</span>, { host: hosts }, { keys: [<span class="string">'host'</span>], pool: core.dbPool }, <span class="function"><span class="keyword">function</span><span class="params">(err, rows)</span> {</span>
            async.forEachSeries(rows, <span class="function"><span class="keyword">function</span><span class="params">(row, next)</span> {</span>
                <span class="keyword">try</span> { 
                    self.doJob(row.type, JSON.parse(row.job));
                } <span class="keyword">catch</span>(e) {
                    logger.error(<span class="string">'processJobs:'</span>, e, row);
                }
                db.del(<span class="string">'backend_jobs'</span>, row, { pool: core.dbPool }, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span> next() });
            }, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                <span class="keyword">if</span> (rows.length) logger.log(<span class="string">'processJobs:'</span>, rows.length, <span class="string">'jobs'</span>);
                <span class="keyword">if</span> (callback) callback();
            });
        });
    }
}

module.exports = server;
core.addContext(<span class="string">'server'</span>, server);</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
