<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
 <title>Backend API</title>
 <link rel="shortcut icon" href="/img/logo.png" type="image/png" />
 <link rel="icon" href="/img/logo.png" type="image/png" />

 <script src="js/jquery.js" type="text/javascript" ></script>

 <script src="js/jquery-ui.js" type="text/javascript" ></script>
 <link href="css/jquery-ui.css" rel="stylesheet" type="text/css" />

 <script src="js/knockout.js" type="text/javascript"></script>

 <script src="js/crypto.js" type="text/javascript"></script>

 <script src="js/backend.js" type="text/javascript"></script>
 <script src="js/backend-jquery-ui.js" type="text/javascript"></script>
 <script src="socket.io.js" type="text/javascript"></script>

 <style>

#loading {
    display:none;
    width: 20px;
    height: 20px;
}

#history {
    width: 100px;
    max-width: 200px;
}

#file {
    max-width: 200px;
}

.header {
    font-weight: bold;
    font: bold 0.9em 'Trebuchet MS',Arial, Helvetica;
    background: #a7cfdf;
    padding: 5px;
    border: solid #ccc 1px;
    border-radius: 6px;
    box-shadow: 0 1px 1px #ccc;
}

.buttons {
    float: right;
    top:0;
    right:100%;
    padding-left: 5px;
    padding-right: 5px;
}

.buttons span {
    padding: 5px;
}
</style>

 <script type="text/javascript">

// Based on https://github.com/ngn/jquery-input-history.git
$(function() {
    $.widget('backend.inputHistory', {
    _create:function() {
        var s, _this = this;
        this.storageKey = 'inputHistory.' + this.element.attr('id');
        this.h0 = Backend.getHistory();
        this.h = this.h0.concat(['']);
        this.i = this.h0.length;
        return this.element.keydown(function(event) {
            switch(event.which) {
            case 13:return _this.enter();
            case 38:return _this.up();
            case 40:return _this.down();
            }
        });
    },
    up:function() {
        if (this.i > 0) {
            this.h[this.i--] = this.element.val();
            this.element.val(this.h[this.i]);
        }
        this._trigger('up');
        return false;
    },
    down:function() {
        if (this.i < this.h0.length){
            this.h[this.i++] = this.element.val();
            this.element.val(this.h[this.i]);
        }
        this._trigger('down');
        return false;
    },
    enter:function() {
        this._trigger('enter');
        if (this.i < this.h0.length){
            this.h[this.i] = this.h0[this.i];
        }
        var v = this.element.val();
        if (this.i >= 0 && this.i >= this.h0.length - 1 && this.h0[this.h0.length - 1] === v) {
            this.h[this.h0.length] = '';
        } else {
        if (this.h0.indexOf(v) > -1) return false;
            this.h[this.h0.length] = v;
            this.h.push('');
            this.h0.push(v);
            localStorage[this.storageKey] = this.h0.join('\n');
        }
        this.i = this.h0.length;
        return false;
    }});
});

 $(function () {
     Backend.debug = 1;
     Backend.apiResponse = ko.observable('');
     Backend.apiUrl = ko.observable('');
     Backend.apiEmail = ko.observable();
     Backend.apiTable = false;
     Backend.apiSocket = ko.observable(0);
     Backend.apiSocket.subscribe(function(val) {
        if (!val) {
            Backend.ioClose();
        } else {
            Backend.ioConnect("", function(data) {
                Backend.formatResponse(data);
            });
        }
     });
     Backend.apiSession = ko.observable(0);
     Backend.apiSession.subscribe(function(val) {
        Backend.session = val;
        Backend.getAccount();
     });

     Backend.getHistory = function(sort) {
        var list = localStorage['inputHistory.url'], a = [];
        list = (list || "").split('\n');
        if (sort) list.sort();
        list.forEach(function(x) { if (x && a.indexOf(x) == -1) a.push(x) });
        return a;
     }
     Backend.clearHistory = function() {
        var url = $('#url').val();
        if (!url) {
            if (!$("#history").prop('selectedIndex')) {
                localStorage['inputHistory.url'] = "";
                this.initHistory();
            }
            return;
        }
        var list = this.getHistory();
        list.splice(list.indexOf(url), 1);
        localStorage['inputHistory.url'] = list.join('\n');
        this.initHistory();
     }
     Backend.initHistory = function() {
        var list = $('#history');
        list.find('option:not(:first)').remove();
        this.getHistory(true).forEach(function(x) { list.append(new Option(x.substr(0, 150), x)); });
     }
     Backend.doLogin = function() {
        Backend.getAccount(function(err, data) {
            Backend.apiEmail(err || data.login);
        });
     }
     Backend.doLogout = function() {
        this.apiEmail("");
        this.logout();
     }
     Backend.showLogin = function() {
        this.login(function(err, data) {
            Backend.apiEmail(err || data.login);
            return 1;
        });
     }
     Backend.formatResponse = function(data) {
        try {
            if (this.apiTable) {
                var d = data.length ? data : (data.data || []);
                var html = "<table><tr>";
                for (var p in d[0]) {
                    if (p.substr(-3) == "_ts") continue;
                    html += "<th>" + p + "</th>"
                }
                html += "</tr>";
                for (var i in d) {
                    html += "<tr>"
                    for (var p in d[i]) {
                        if (String(d[i][p]).indexOf("http://") == 0) d[i][p] = "<a href=" + d[i][p] + ">" + d[i][p] + "</a>";
                        html += "<td>" + d[i][p] + "</td>";
                    }
                    html += "</tr>"
                }
                html += "</table>";
                data = html;
            } else {
                data = this.formatJSON(data, " ");
            }
            this.apiResponse(data);
        } catch(e) {
            this.apiResponse(e.toString())
        }
     }
     Backend.doPrepare = function(options) {
        var file = $("#file")[0];
        if (!file.files.length) return true;
        if (!Backend.session) {
            Backend.apiResponse("Please enable session in order to upload files.");
            return false;
        }
        var form = new FormData(), obj = {}, fn = "icon";
        if (options.url.indexOf("?") > -1) {
            var url = options.url.split("?");
            var q = url[1].replace(/\+/gi," ").split("&");
            for (var i in q) {
                var v = q[i].split("=");
                fn = unescape(v[0]);
                if (v[1]) form.append(fn, unescape(v[1]));
            }
            options.url = url[0];
        }
        form.append(fn, file.files[0]);
        options.type = "POST";
        options.data = form;
        options.contentType = false;
        options.nosignature = true;
        options.processData = false;
        return true;
     }
     Backend.doRun = function() {
         var self = this;
         var url = $('#url').val();
         if (!url) return;
         $('#icon').empty();

         // Request for an image, re-route to image container
         if (/^\/image\/|(^\/account\/get\/icon)|(^\/icon\/get\/)|(^\/message\/image)/.test(url)) {
             self.apiResponse("");
             $("<img />").attr('src', self.signUrl(url)).load(function() {
                 if (this.complete && this.naturalWidth) $("#icon").append(this);
                 $("#file").val('');
             });
         } else {
             if (Backend.socket) return Backend.ioSend(url);

             var options = { url: url };
             if (!Backend.doPrepare(options)) return;
             Backend.send(options, function(data) {
                 $("#file").val('');
                 Backend.formatResponse(data);
             }, function(msg, xhr, status, error) {
                 $("#file").val('');
                 self.apiResponse(error + "\n" + xhr.responseText);
             });
         }
     }

     $('#history').on('change', function() {
        $('#url').val($('#history').val());
        Backend.doRun();
     });

     $('#url').inputHistory({
         enter: function() { Backend.doRun() }
     });
     ko.applyBindings(Backend);
     Backend.doLogin();
     Backend.initHistory();
 });
 </script>

</head>
<body>
<div id="header" class="header">
   <div class='buttons'>
     <span title="Login into the account" onclick="Backend.showLogin()">Login</span>
     <span title="Logout and clear the session" onclick="Backend.doLogout()" >Logout</span>
     <span title="Documentation" onclick="window.open('doc.html')" >Help</span>
   </div>
   <span class="title" title="Logged in account email or error status" style="float:right;" data-bind='text: apiEmail' ></span>
   <p style="clear:both;" />

   <div class="center">
     <form data-bind="submit: doRun">
     <table border=0>
      <tr><td>URL:</td>
          <td><input id="url" type="search" size=100" /></td>
          <td><button type="submit" >Run</button></td>
          <td><select id="history" title="Clear the current url or all if at the top"><option>History...</option></select></td>
          <td><button onclick="Backend.clearHistory()" title="Remove current request from the history">Clear</button></td>
          <td><input type="file" id="file" name="file" title="Upload a file, the last param in url must be empty like '/account/put/icon?type=0&icon=', it will be used for a file"/></td>
       </tr>
       <tr>
          <td colspan=2></td>
          <td><input type="checkbox" data-bind="checked: apiSocket" title="Use socket.io connection instead of HTTP"/> Socket.io</td>
          <td><input type="checkbox" data-bind="checked: apiSession" title="Create a web session, it is needed to use file uploads from the console"/> Session</td>
          <td><input type="checkbox" data-bind="checked: apiTable" title="Show in tabular format"/> Tabular</td>
          <td><img id="loading" src="img/loading.gif"></td>
      </tr>
     </table>
     </form>
   </div>
   <br style="clear:both;"/>
</div>

<pre><span data-bind="html: apiResponse" ></span></pre>
<div id="icon"></div>

</body>
</html>
