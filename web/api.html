<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
 <title>Backend API</title>
 <link rel="shortcut icon" href="/img/logo.png" type="image/png" />
 <link rel="icon" href="/img/logo.png" type="image/png" />

 <script src="js/jquery.js" type="text/javascript" ></script>
 
 <script src="js/jquery-ui.js" type="text/javascript" ></script>
 <link href="css/jquery-ui.css" rel="stylesheet" type="text/css" />
 
 <script src="js/knockout.js" type="text/javascript"></script>

 <script src="js/backend.js" type="text/javascript"></script>
 <link href="css/backend.css" rel="stylesheet" type="text/css" />
 
 <script src="js/sha1.js" type="text/javascript"></script>

 <style>
#loading {
    display:none;
    width: 20px;
    height: 20px;
}

.login-buttons {
    float: right;
    top:0;
    right:100%;
    padding-left: 5px;
    padding-right: 5px;
}
</style>
 
 <script type="text/javascript">

 $(function () {
     Backend.apiResponse = ko.observable('');
     Backend.apiUrl = ko.observable('');
     Backend.apiEmail = Backend.getCredentials().email;
     Backend.apiImages = false;
     Backend.apiTable = false;

     Backend.doRun = function() {
         var self = this;
         if (!self.apiUrl()) return;
         $('#icon').empty();

         // Request for an image, re-route to image container
         if (/^\/([^\/]+)\/image\/([a-z])?\/?([0-9]+)|(^\/logo\/[a-z0-9]+)/.test(self.apiUrl())) {
             self.apiResponse("");
             $("<img />").attr('src', self.apiUrl()).load(function() {
                 if (this.complete && this.naturalWidth) $("#icon").append(this);
             });
         } else {
             var options = { url: self.apiUrl() };
             Backend.send(options, function(data) {
                 var name = self.apiUrl().split('/')[1];
                 try {
                     if (self.apiTable && data.length) {
                         var html = "<table><tr>";
                         for (var p in data[0]) {
                             if (p.substr(-3) == "_ts") continue;
                             html += "<th>" + p + "</th>"
                         }
                         html += "</tr>";
                         for (var i in data) {
                             html += "<tr>"
                             if (self.apiImages && data[i].id) html += "<td><img src='/image/" +  name + "/" + data[i].id + "' width=32 height=32'></td>";
                             for (var p in data[i]) {
                                 if (p.substr(-3) == "_ts") continue;
                                 if (String(data[i][p]).indexOf("http://") == 0) data[i][p] = "<a href=" + data[i][p] + ">" + data[i][p] + "</a>";
                                 html += "<td>" + data[i][p] + "</td>";
                             }
                             html += "</tr>"
                         }
                         html += "</table>";
                         data = html;
                     } else {
                         data = Backend.formatJSON(data, " ");
                     }
                     self.apiResponse(data);
                 } catch(e) {
                     self.apiResponse(e.toString())
                 }
             }, function(msg, xhr, status, error) {
                 self.apiResponse(error + "\n" + xhr.responseText);
             });
         }
     }
     ko.applyBindings(Backend);
     Backend.login();
 });
 </script>

</head>
<body>
<div id="header" class="header">
   <div class='login-buttons'><span onclick="Backend.login()">Login</span><span onclick="Backend.logout()" >Logout</span></div>
   <span class="title" style="float:right;" data-bind='text: apiEmail' ></span>
   <p style="clear:both;" />

   <div class="center">
     <form data-bind="submit: doRun">
     <table border=0>
      <tr><td>URL:</td>
          <td><input id="url" type="text" size=80" data-bind='value: apiUrl' /></td>
          <td colspan=3><button type="submit" >Run</button></td>
          <td><input type="checkbox" data-bind="checked: apiImages" title="Show images by id"/></td>
          <td>Show Icons</td>
          <td><input type="checkbox" data-bind="checked: apiTable" title="Show in tabular format"/></td>
          <td>Tabular</td>
          <td colspan=2><img id="loading" src="img/loading.gif"></td>
      </tr>
     </table>
     </form>
   </div>
   <br style="clear:both;"/>
</div>

<pre><span data-bind="html: apiResponse" ></span></pre>
<div id="icon"></div>

</body>
</html>
